<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>สารสนเทศเยี่ยมบ้านนักเรียน</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css" />
    <link href="https://fonts.googleapis.com/css2?family=Prompt&family=Google+Sans:wght@400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/remixicon/4.2.0/remixicon.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.2/css/all.min.css" integrity="sha512-1sCRPdkRXhBV2PBLUdRb4tMg1w2YPf37qatUFeS7zlBy7jJI8Lf4VHwWfZZfpXtYSLy85pkm9GaYVYMfw5BC1A==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link href="https://cdn.datatables.net/1.13.7/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    <link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-table@1.20.0/dist/bootstrap-table.min.css">
    <link rel="stylesheet" href="https://cdn.datatables.net/buttons/2.3.6/css/buttons.bootstrap5.min.css">
    <link rel="stylesheet" href="styles.css">
    <link rel="icon" href="https://raw.githubusercontent.com/infobwd/STUDENT-CARE/main/icons8-information-96.png" type="image/x-icon"> <!-- Update with the path to your favicon -->
    <script src="https://cdn.lordicon.com/lordicon.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/bodymovin/5.7.13/lottie.min.js"></script>
</head>
<body style="font-family: 'Google Sans', sans-serif;">
    <!-- Nav Section -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="https://student-carewd.glitch.me/">
                <img src="https://raw.githubusercontent.com/infobwd/STUDENT-CARE/main/icons8-information-96.png" alt="Logo" width="30" height="30" class="d-inline-block align-top"> สารสนเทศเยี่ยมบ้านนักเรียน
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNavDropdown" aria-controls="navbarNavDropdown" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNavDropdown">
                <ul class="navbar-nav me-auto">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            เมนู
                        </a>
                     <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdownMenuLink">
                            <li><a class="dropdown-item" href="index.html"><i class="fas fa-house-user"></i> ข้อมูลเยี่ยมบ้าน และ สถานะครอบครัว</a></li>
                            <li><a class="dropdown-item" href="residence.html"><i class="fas fa-home"></i> ข้อมูลการอยู่อาศัย</a></li>
                            <li><a class="dropdown-item" href="floorMaterial.html"><i class="fas fa-hammer"></i> วัสดุที่ใช้ทำบ้าน</a></li>
                            <li><a class="dropdown-item" href="electricity.html"><i class="fas fa-lightbulb"></i> แหล่งน้ำดื่ม|แหล่งไฟฟ้า</a></li>
                            <li><a class="dropdown-item" href="land.html"><i class="fas fa-tractor"></i> ที่ดินทำการเกษตร และ ยานพาหนะ</a></li>
                            <li><a class="dropdown-item" href="occupations.html"><i class="fas fa-briefcase"></i> อาชีพผู้ปกครองและรายได้</a></li>
                            <li><a class="dropdown-item" href="map.html"><i class="fas fa-map-marked-alt"></i> แผนที่เยี่ยมบ้าน</a></li>
                    </ul>
                    </li>
                </ul>
                <form class="d-flex flex-fill" role="search" action="search.html" method="get">
                    <input class="form-control me-2" type="text" inputmode="numeric" pattern="[0-9]*" placeholder="ค้นหาโดยรหัสนักเรียน" aria-label="Search" id="studentIdSearch" name="studentId">
                    <button class="btn btn-outline-light me-2" type="submit">ค้นหา</button>
                </form>
                <button id="fullscreenButton" class="btn btn-outline-light me-2">ขยายเต็มจอ</button>
                <button id="fontSizeButton" class="btn btn-outline-light me-2">ก</button>
                <button id="login-button" class="btn btn-primary"><i class="fab fa-line"></i> LINE Login</button>
            </div>
        </div>
    </nav>
    <br>
    <div id="content-section" class="container mt-5" style="margin-top: 70px;">
        <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center mb-3">
            <div class="text-start order-2 order-md-1">
                <span id="currentDateTime" class="currentDateTime"></span>
            </div>
            <div class="text-end order-1 order-md-2">
                <img id="profile-picture" src="" alt="Profile Picture" class="rounded-circle" width="50" height="50" style="display: none;">
                <span id="profile-name" class="ms-2"></span>
                <button id="logout-button" class="btn btn-secondary ms-2" style="display: none;">Logout</button>
                <button id="share-button" class="btn btn-success ms-2" style="display: none;"><i class="fab fa-line"></i> Share</button>
            </div>
        </div>
        <h2>เลือกภาคเรียนที่</h2>
        <select id="semesterDropdown" class="form-control mb-4"></select>

        <!-- ข้อมูลวัสดุที่ใช้ทำฝาบ้าน -->
        <h2>วัสดุที่ใช้ทำฝาบ้าน</h2>
        <ul class="box-info" id="wallMaterialList"></ul>

        <!-- ข้อมูลวัสดุที่ใช้ทำพื้นบ้าน -->
        <h2>วัสดุที่ใช้ทำพื้นบ้าน</h2>
        <ul class="box-info" id="floorMaterialList"></ul>

        <!-- ข้อมูลวัสดุที่ใช้ทำหลังคา -->
        <h2>วัสดุที่ใช้ทำหลังคา</h2>
        <ul class="box-info" id="roofMaterialList"></ul>

        <div class="mb-3 marquee">
            <div><span id="newsTicker"></span></div>
            <a href="news.html" class="news-button">อ่านข่าวทั้งหมด</a>
        </div>
    </div>
    <br>
    <!-- Footer Section -->
    <div id="footer-section">
        <footer class="footer">
            <div class="container">
                <div class="row">
                    <div class="col-md-3 mb-4">
                        <h5>Address</h5>
                        <p>โรงเรียนบ้านวังด้ง 111 หมู่ 11 ตำบลหนองกุ่ม อำเภอบ่อพลอย จังหวัดกาญจนบุรี รหัสไปรษณีย์ 71160</p>
                    </div>
                    <div class="col-md-3 mb-4">
                        <h5>Contact Us</h5>
                        <ul class="list-unstyled">
                            <li><a href="mailto:info@bwd.ac.th"><i class="fa fa-envelope"></i> info@bwd.ac.th</a></li>
                            <li><a href="tel:+66836645989"><i class="fa fa-phone"></i> 083-664-5989 [ผอ.นพรุจ]</a></li>
                            <li><a href="tel:+66655066852"><i class="fa fa-phone"></i> 065-506-6852 [คุณครูหทัยชนก]</a></li>
                        </ul>
                    </div>
                    <div class="col-md-3 mb-4">
                        <h5>Social Media</h5>
                        <ul class="list-unstyled list-inline">
                            <li class="list-inline-item">
                                <a href="#" class="btn btn-social"><i class="fab fa-facebook-f"></i></a>
                            </li>
                            <li class="list-inline-item">
                                <a href="#" class="btn btn-social"><i class="fab fa-youtube"></i></a>
                            </li>
                            <li class="list-inline-item">
                                <a href="#" class="btn btn-social"><i class="fab fa-instagram"></i></a>
                            </li>
                            <li class="list-inline-item">
                                <a href="#" class="btn btn-social"><i class="fab fa-tiktok"></i></a>
                            </li>
                        </ul>
                    </div>
                    <div class="col-md-3 mb-4">
                        <h5>Follow Us</h5>
                        <img src="https://raw.githubusercontent.com/infobwd/wdconnect/main/M_747spikt_GW.png" alt="QR Code" width="100" height="100" class="mb-2">
                    </div>
                </div>
            </div>
        </footer>
        <div class="footer-bottom">
            <div class="container">
                <p>&copy; 2024 โรงเรียนบ้านวังด้ง. All Rights Reserved.</p>
            </div>
        </div>
    </div>
    <!-- Chat Button -->
    <button onclick="chatFunction()" id="chatBtn" title="Chat with us"><i class="fa fa-comments"></i></button>
    <!-- Search Popup Modal -->
    <div class="modal fade" id="searchModal" tabindex="-1" aria-labelledby="searchModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="searchModalLabel">Search</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>ค้นหานักเรียนรหัส: <span id="searchedStudentId"></span></p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary">Search</button>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.datatables.net/1.13.7/js/dataTables.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
    <script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/dataTables.buttons.min.js"></script>
    <script src="https://cdn.datatables.net/buttons/2.3.6/js/buttons.bootstrap5.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.1.3/jszip.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/pdfmake.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.36/vfs_fonts.js"></script>
    <script>
        $(document).ready(function () {
            $('#login-button').click(function () {
                liff.login();
            });

            $('#logout-button').click(function () {
                logout();
            });

            $('#share-button').click(function () {
                shareData();
            });

            $('#fullscreenButton').click(function () {
                toggleFullscreen();
            });

            $('#fontSizeButton').click(function () {
                toggleFontSize();
            });

            initializeLiff();
            loadWallMaterialData();
            loadFloorMaterialData();
            loadRoofMaterialData();
            loadNewsData();

            setInterval(function () {
                loadWallMaterialData($('#semesterDropdown').val());
                loadFloorMaterialData($('#semesterDropdown').val());
                loadRoofMaterialData($('#semesterDropdown').val());
            }, 30000); // Reload data every 30 seconds

            updateDateTime();
            setInterval(updateDateTime, 1000); // Update date and time every second
        });

        async function initializeLiff() {
            try {
                await liff.init({
                    liffId: '2005494853-r1GwQYY5'
                });
                if (liff.isLoggedIn()) {
                    displayUserInfo();
                    $('#login-button').hide(); // Hide login button after login
                }
            } catch (error) {
                console.error('LIFF initialization failed', error);
            }
        }

        async function displayUserInfo() {
            const profile = await liff.getProfile();
            $('#profile-name').text(profile.displayName);
            $('#profile-picture').attr('src', profile.pictureUrl).show();
            $('#logout-button').show();
            $('#share-button').show();
        }

       function loadWallMaterialData(semester) {
    fetch('https://opensheet.elk.sh/1EZtfvb0h9wYZbRFTGcm0KVPScnyu6B-boFG6aMpWEUo/วัสดุที่ใช้ทำ(ฝาบ้าน)')
        .then(response => response.json())
        .then(data => {
            const selectedData = data.find(item => item['ปีการศึกษา'] === semester);
            if (!selectedData) return;

            const totalHouses = parseInt(selectedData['รวม'].replace(/,/g, ''));

            const materials = [
                {
                    type: 'ฉาบซีเมนต์',
                    icon: 'https://cdn-icons-png.flaticon.com/512/12309/12309438.png',
                    amount: parseInt(selectedData['ฉาบซีเมนต์'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['ฉาบซีเมนต์'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'อิฐ/ก้อนปูน/อิฐบล็อก',
                    icon: 'https://cdn-icons-png.flaticon.com/512/7899/7899426.png',
                    amount: parseInt(selectedData['อิฐ/ก้อนปูน/อิฐบล็อก'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['อิฐ/ก้อนปูน/อิฐบล็อก'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'สังกะสี',
                    icon: 'https://cdn-icons-png.flaticon.com/512/4657/4657836.png',
                    amount: parseInt(selectedData['สังกะสี'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['สังกะสี'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'ไม้กระดาน',
                    icon: 'https://cdn-icons-png.flaticon.com/512/9410/9410536.png',
                    amount: parseInt(selectedData['ไม้กระดาน'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['ไม้กระดาน'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'ไม้ไผ่/ท่อนไม้/เศษไม้',
                    icon: 'https://cdn-icons-png.flaticon.com/512/15622/15622426.png',
                    amount: parseInt(selectedData['ไม้ไผ่/ท่อนไม้/เศษไม้'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['ไม้ไผ่/ท่อนไม้/เศษไม้'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'ดิน ไวนิล และอื่น ๆ',
                    icon: 'https://cdn-icons-png.flaticon.com/512/9421/9421125.png',
                    amount: parseInt(selectedData['ดิน ไวนิล และอื่น ๆ'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['ดิน ไวนิล และอื่น ๆ'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                }
            ];

            const listElement = document.getElementById('wallMaterialList');
            listElement.innerHTML = '';

            materials.forEach(material => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <img src="${material.icon}" style="width: 80px; height: 80px;" alt="${material.type}">
                    <span class="text">
                        <p>${material.type}</p>
                        <h3>${material.amount} <span style="font-size: 12px">(หลัง)</span></h3>
                        <p><span>${material.percent}%</span></p>
                    </span>
                `;
                listElement.appendChild(listItem);
            });
        })
        .catch(error => console.error('Error fetching wall materials data:', error));
}

function loadFloorMaterialData(semester) {
    fetch('https://opensheet.elk.sh/1EZtfvb0h9wYZbRFTGcm0KVPScnyu6B-boFG6aMpWEUo/วัสดุที่ใช้ทำพื้นบ้าน')
        .then(response => response.json())
        .then(data => {
            const selectedData = data.find(item => item['ปีการศึกษา'] === semester);
            if (!selectedData) return;

            const totalHouses = parseInt(selectedData['รวม'].replace(/,/g, ''));

            const materials = [
                {
                    type: 'กระเบื้อง/เซรามิค',
                    icon: 'https://cdn-icons-png.flaticon.com/512/14243/14243819.png',
                    amount: parseInt(selectedData['กระเบื้อง/เซรามิค'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['กระเบื้อง/เซรามิค'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'ปาเก้/ไม้ขัดเงา',
                    icon: 'https://cdn-icons-png.flaticon.com/512/222/222655.png',
                    amount: parseInt(selectedData['ปาเก้/ไม้ขัดเงา'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['ปาเก้/ไม้ขัดเงา'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'ซีเมนต์เปลือย',
                    icon: 'https://cdn-icons-png.flaticon.com/512/4631/4631732.png',
                    amount: parseInt(selectedData['ซีเมนต์เปลือย'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['ซีเมนต์เปลือย'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'ไม้กระดาน',
                    icon: 'https://cdn-icons-png.flaticon.com/512/12888/12888213.png',
                    amount: parseInt(selectedData['ไม้กระดาน'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['ไม้กระดาน'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'ไวนิล/กระเบื้องยาง/เสื่อน้ำมัน',
                    icon: 'https://cdn-icons-png.flaticon.com/512/3079/3079007.png',
                    amount: parseInt(selectedData['ไวนิล/กระเบื้องยาง/เสื่อน้ำมัน'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['ไวนิล/กระเบื้องยาง/เสื่อน้ำมัน'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'ไม้ไผ่',
                    icon: 'https://cdn-icons-png.flaticon.com/512/15622/15622426.png',
                    amount: parseInt(selectedData['ไม้ไผ่'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['ไม้ไผ่'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'ดิน/ทราย',
                    icon: 'https://cdn-icons-png.flaticon.com/512/9421/9421125.png',
                    amount: parseInt(selectedData['ดิน/ทราย'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['ดิน/ทราย'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'อื่น ๆ',
                    icon: 'https://cdn-icons-png.flaticon.com/512/5587/5587327.png',
                    amount: parseInt(selectedData['อื่น ๆ'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['อื่น ๆ'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                }
            ];

            const listElement = document.getElementById('floorMaterialList');
            listElement.innerHTML = '';

            materials.forEach(material => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <img src="${material.icon}" style="width: 80px; height: 80px;" alt="${material.type}">
                    <span class="text">
                        <p>${material.type}</p>
                        <h3>${material.amount} <span style="font-size: 12px">(หลัง)</span></h3>
                        <p><span>${material.percent}%</span></p>
                    </span>
                `;
                listElement.appendChild(listItem);
            });
        })
        .catch(error => console.error('Error fetching floor materials data:', error));
}

function loadRoofMaterialData(semester) {
    fetch('https://opensheet.elk.sh/1EZtfvb0h9wYZbRFTGcm0KVPScnyu6B-boFG6aMpWEUo/วัสดุที่ใช้ทำหลังคา')
        .then(response => response.json())
        .then(data => {
            const selectedData = data.find(item => item['ปีการศึกษา'] === semester);
            if (!selectedData) return;

            const totalHouses = parseInt(selectedData['รวม'].replace(/,/g, ''));

            const materials = [
                {
                    type: 'โลหะ (เช่น สังกะสี/เหล็ก/อะลูมิเนียม)',
                    icon: 'https://cdn-icons-png.flaticon.com/512/4657/4657836.png',
                    amount: parseInt(selectedData['โลหะ (เช่น สังกะสี/เหล็ก/อะลูมิเนียม)'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['โลหะ (เช่น สังกะสี/เหล็ก/อะลูมิเนียม)'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'กระเบื้อง/เซรามิค',
                    icon: 'https://cdn-icons-png.flaticon.com/512/16039/16039330.png',
                    amount: parseInt(selectedData['กระเบื้อง/เซรามิค'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['กระเบื้อง/เซรามิค'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'ไม้กระดาน',
                    icon: 'https://cdn-icons-png.flaticon.com/512/8812/8812819.png',
                    amount: parseInt(selectedData['ไม้กระดาน'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['ไม้กระดาน'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                },
                {
                    type: 'ใบไม้/วัสดุธรรมชาติ',
                    icon: 'https://cdn-icons-png.flaticon.com/512//9590/9590579.png',
                    amount: parseInt(selectedData['ใบไม้/วัสดุธรรมชาติ'].replace(/,/g, '')),
                    percent: ((parseInt(selectedData['ใบไม้/วัสดุธรรมชาติ'].replace(/,/g, '')) / totalHouses) * 100).toFixed(2)
                }
            ];

            const listElement = document.getElementById('roofMaterialList');
            listElement.innerHTML = '';

            materials.forEach(material => {
                const listItem = document.createElement('li');
                listItem.innerHTML = `
                    <img src="${material.icon}" style="width: 80px; height: 80px;" alt="${material.type}">
                    <span class="text">
                        <p>${material.type}</p>
                        <h3>${material.amount} <span style="font-size: 12px">(หลัง)</span></h3>
                        <p><span>${material.percent}%</span></p>
                    </span>
                `;
                listElement.appendChild(listItem);
            });
        })
        .catch(error => console.error('Error fetching roof materials data:', error));
}

function shareData() {
    const profilePicture = $('#profile-picture').attr('src');
    const profileName = $('#profile-name').text();
    const currentDateTime = new Date().toLocaleString('th-TH', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: 'numeric',
        minute: 'numeric',
        second: 'numeric',
        weekday: 'long',
        hour12: false
    });

    const wallMaterials = Array.from(document.querySelectorAll('#wallMaterialList li')).map(li => {
        const type = li.querySelector('p').innerText;
        const amount = li.querySelector('h3').innerText.replace(' (หลัง)', '');
        const percent = li.querySelector('span span').innerText;
        return { type, amount, percent };
    });

    const floorMaterials = Array.from(document.querySelectorAll('#floorMaterialList li')).map(li => {
        const type = li.querySelector('p').innerText;
        const amount = li.querySelector('h3').innerText.replace(' (หลัง)', '');
        const percent = li.querySelector('span span').innerText;
        return { type, amount, percent };
    });

    const roofMaterials = Array.from(document.querySelectorAll('#roofMaterialList li')).map(li => {
        const type = li.querySelector('p').innerText;
        const amount = li.querySelector('h3').innerText.replace(' (หลัง)', '');
        const percent = li.querySelector('span span').innerText;
        return { type, amount, percent };
    });

    const flexMessage = {
        type: "flex",
        altText: "วัสดุที่ใช้ทำบ้าน",
        contents: {
            type: "carousel",
            contents: [
                {
                    type: "bubble",
                    size: "giga",
                    hero: {
                        type: "image",
                        url: "https://raw.githubusercontent.com/infobwd/STUDENT-CARE/main/headStudentCare2.png",
                        size: "full",
                        aspectRatio: "40:10",
                        aspectMode: "cover"
                    },
                    body: {
                        type: "box",
                        layout: "vertical",
                        contents: [
                            {
                                type: "text",
                                text: "วัสดุที่ใช้ทำฝาบ้าน",
                                weight: "bold",
                                size: "xl",
                                align: "center"
                            },
                            {
                                type: "separator",
                                margin: "md"
                            },
                            {
                                type: "box",
                                layout: "vertical",
                                margin: "lg",
                                spacing: "sm",
                                contents: wallMaterials.map(material => ({
                                    type: "box",
                                    layout: "baseline",
                                    spacing: "sm",
                                    contents: [
                                        {
                                            type: "text",
                                            text: material.type,
                                            color: "#aaaaaa",
                                            wrap: true,
                                            size: "sm",
                                            flex: 5
                                        },
                                        {
                                            type: "text",
                                            text: `${material.amount} หลัง`,
                                            wrap: true,
                                            color: "#666666",
                                            size: "sm",
                                            flex: 2
                                        }
                                    ]
                                }))
                            }
                        ]
                    },
                    footer: {
                        type: "box",
                        layout: "vertical",
                        contents: [
                            {
                                type: "separator",
                                margin: "sm"
                            },
                            {
                                type: "image",
                                url: profilePicture,
                                size: "sm",
                                aspectMode: "cover",
                                aspectRatio: "1:1",
                                gravity: "bottom",
                                margin: "md"
                            },
                            {
                                type: "text",
                                text: "ข้อมูลโดย : " + profileName,
                                weight: "bold",
                                size: "sm",
                                align: "center"
                            },
                            {
                                type: "text",
                                text: "ข้อมูล ณ. " + currentDateTime,
                                wrap: true,
                                size: "xs",
                                color: "#aaaaaa",
                                align: "center"
                            },
                            {
                                type: "button",
                                style: "secondary",
                                height: "sm",
                                action: {
                                    type: "uri",
                                    label: "App เยี่ยมบ้าน",
                                    uri: "https://liff.line.me/2005230346-ND61qqrg"
                                },
                                style: "primary",
                                color: "#1DB446",
                                margin: "md"
                            },
                            {
                                type: "button",
                                style: "secondary",
                                height: "sm",
                                action: {
                                    type: "uri",
                                    label: "View more",
                                    uri: "https://liff.line.me/2005494853-r1GwQYY5"
                                },
                                style: "primary",
                                color: "#1DB446",
                                margin: "md"
                            }
                        ],
                        spacing: "sm",
                        paddingTop: "10px"
                    }
                },
                {
                    type: "bubble",
                    size: "giga",
                    hero: {
                        type: "image",
                        url: "https://raw.githubusercontent.com/infobwd/STUDENT-CARE/main/headStudentCare2.png",
                        size: "full",
                        aspectRatio: "40:10",
                        aspectMode: "cover"
                    },
                    body: {
                        type: "box",
                        layout: "vertical",
                        contents: [
                            {
                                type: "text",
                                text: "วัสดุที่ใช้ทำพื้นบ้าน",
                                weight: "bold",
                                size: "xl",
                                align: "center"
                            },
                            {
                                type: "separator",
                                margin: "md"
                            },
                            {
                                type: "box",
                                layout: "vertical",
                                margin: "lg",
                                spacing: "sm",
                                contents: floorMaterials.map(material => ({
                                    type: "box",
                                    layout: "baseline",
                                    spacing: "sm",
                                    contents: [
                                        {
                                            type: "text",
                                            text: material.type,
                                            wrap: true,
                                            color: "#aaaaaa",
                                            size: "sm",
                                            flex: 5
                                        },
                                        {
                                            type: "text",
                                            text: `${material.amount} หลัง`,
                                            wrap: true,
                                            color: "#666666",
                                            size: "sm",
                                            flex: 2
                                        }
                                    ]
                                }))
                            },
                            {
                                type: "text",
                                text: "วัสดุที่ใช้ทำหลังคา",
                                weight: "bold",
                                size: "xl",
                                align: "center"
                            },
                          {
                                type: "separator",
                                margin: "md"
                            },
                            {
                                type: "box",
                                layout: "vertical",
                                margin: "lg",
                                spacing: "sm",
                                contents: roofMaterials.map(material => ({
                                    type: "box",
                                    layout: "baseline",
                                    spacing: "sm",
                                    contents: [
                                        {
                                            type: "text",
                                            text: material.type,
                                            wrap: true,
                                            color: "#aaaaaa",
                                            size: "sm",
                                            flex: 5
                                        },
                                        {
                                            type: "text",
                                            text: `${material.amount} หลัง`,
                                            wrap: true,
                                            color: "#666666",
                                            size: "sm",
                                            flex: 2
                                        }
                                    ]
                                }))
                            }
                        ]
                    },
                    footer: {
                        type: "box",
                        layout: "vertical",
                        contents: [
                            {
                                type: "separator",
                                margin: "sm"
                            },
                            {
                                type: "button",
                                style: "secondary",
                                height: "sm",
                                action: {
                                    type: "uri",
                                    label: "View more",
                                    uri: "https://liff.line.me/2005494853-r1GwQYY5"
                                },
                                style: "primary",
                                color: "#1DB446",
                                margin: "md"
                            }
                        ],
                        spacing: "sm",
                        paddingTop: "10px"
                    }
                }
                
            ]
        }
    };

    liff.shareTargetPicker([flexMessage])
        .then(() => {
            liff.closeWindow();
        })
        .catch(function (error) {
            console.error('Error sending message: ', error);
        });
}


        function loadNewsData() {
            fetch('https://opensheet.elk.sh/1EZtfvb0h9wYZbRFTGcm0KVPScnyu6B-boFG6aMpWEUo/ข่าวประกาศ')
                .then(response => response.json())
                .then(data => {
                    let newsHtml = data.map(news => {
                        let date = news.วันที่.replace(' +0700', ''); // ตัดข้อความ "+0000" ออก
                        return `📰 <a href="${news.Link}" target="_blank">${news.หัวข้อข่าว}: 📆 (${date})</a>`;
                    }).join(' | ');
                    $('#newsTicker').html(newsHtml);
                });
        }

        function logout() {
            liff.logout();
            window.location.reload();
        }

        function chatFunction() {
            window.open('https://line.me/R/ti/p/@747spikt', '_blank');
        }

        function toggleFullscreen() {
            if (!document.fullscreenElement) {
                document.documentElement.requestFullscreen();
                $('#fullscreenButton').text('ย่อขนาดจอ');
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                    $('#fullscreenButton').text('ขยายเต็มจอ');
                }
            }
        }

        function toggleFontSize() {
            let currentSize = parseInt($('body').css('font-size'));
            if (currentSize === 16) {
                $('body').css('font-size', '20px');
            } else if (currentSize === 20) {
                $('body').css('font-size', '24px');
            } else {
                $('body').css('font-size', '16px');
            }
        }

        function updateDateTime() {
            const currentDateTime = new Date().toLocaleString('th-TH', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: 'numeric',
                minute: 'numeric',
                second: 'numeric',
                weekday: 'long',
                hour12: false
            });
            $('#currentDateTime').text(currentDateTime);
        }

        document.addEventListener('DOMContentLoaded', function () {
            populateDropdown();

            document.getElementById('semesterDropdown').addEventListener('change', function () {
                const selectedSemester = this.value;
                loadWallMaterialData(selectedSemester);
                loadFloorMaterialData(selectedSemester);
                loadRoofMaterialData(selectedSemester);
            });

            document.addEventListener('click', function (e) {
                if (!e.target.closest('.navbar-nav') && !e.target.closest('#studentIdSearch')) {
                    var navbarCollapse = document.querySelector('.navbar-collapse');
                    var bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                    if (bsCollapse) bsCollapse.hide();
                }
            });

            document.querySelectorAll('.dropdown-toggle').forEach(function (element) {
                element.addEventListener('click', function (e) {
                    if (window.innerWidth < 992) {
                        e.preventDefault();
                        e.stopPropagation();
                        this.nextElementSibling.classList.toggle('show');
                    }
                });
            });

            document.querySelectorAll('.dropdown-item').forEach(function (element) {
                element.addEventListener('click', function () {
                    var navbarCollapse = document.querySelector('.navbar-collapse');
                    var bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                    if (bsCollapse) bsCollapse.hide();
                });
            });

            const inputField = document.getElementById('studentIdSearch');
            inputField.addEventListener('focus', function () {
                var navbarCollapse = document.querySelector('.navbar-collapse');
                var bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                if (bsCollapse) bsCollapse.show();
            });

            inputField.addEventListener('blur', function () {
                setTimeout(() => {
                    if (!inputField.matches(':focus')) {
                        var navbarCollapse = document.querySelector('.navbar-collapse');
                        var bsCollapse = bootstrap.Collapse.getInstance(navbarCollapse);
                        if (bsCollapse) bsCollapse.hide();
                    }
                }, 200);
            });

            inputField.addEventListener('input', function () {
                this.value = this.value.replace(/[^0-9]/g, '');
            });
        });

        function populateDropdown() {
            fetch('https://opensheet.elk.sh/1EZtfvb0h9wYZbRFTGcm0KVPScnyu6B-boFG6aMpWEUo/ปีการศึกษา')
                .then(response => response.json())
                .then(data => {
                    const dropdown = document.getElementById('semesterDropdown');
                    data.forEach(item => {
                        const option = document.createElement('option');
                        option.value = item['ปีการศึกษา'];
                        option.text = item['ปีการศึกษา'];
                        dropdown.appendChild(option);
                    });

                    // Load data for the first semester by default
                    loadWallMaterialData(data[0]['ปีการศึกษา']);
                    loadFloorMaterialData(data[0]['ปีการศึกษา']);
                    loadRoofMaterialData(data[0]['ปีการศึกษา']);
                });
        }
    </script>
</body>

</html>
