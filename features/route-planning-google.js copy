// features/route-planning-google.js
// ‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏û‡∏£‡πâ‡∏≠‡∏° Google Maps Integration

const RoutePlanningGoogle = {
    isInitialized: false,
    optimizedRoute: [],
    
    // ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå
    init() {
        if (this.isInitialized) return;
        console.log('üöó Initializing Route Planning with Google Maps...');
        
        // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
        if (typeof map === 'undefined' || typeof homeVisitData === 'undefined') {
            setTimeout(() => this.init(), 1000);
            return;
        }
        
        this.createRouteButton();
        this.isInitialized = true;
        console.log('‚úÖ Route Planning with Google Maps loaded successfully');
    },
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏∏‡πà‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
    createRouteButton() {
    const controlBar = document.querySelector('.btn-group');
    if (!controlBar) return;
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏õ‡∏∏‡πà‡∏°‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
    const existingBtn = document.getElementById('routePlanningGoogleBtn');
    if (existingBtn) {
        existingBtn.remove(); // ‡∏•‡∏ö‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏Å‡πà‡∏≤‡∏≠‡∏≠‡∏Å
    }
    
    const routeBtn = document.createElement('button');
    routeBtn.id = 'routePlanningGoogleBtn';
    routeBtn.className = 'btn btn-outline-success btn-sm';
    routeBtn.innerHTML = '<i class="fab fa-google"></i> Google ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á';
    routeBtn.onclick = () => this.showRoutePlanningModal();
    
    // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏´‡∏•‡∏±‡∏á‡∏õ‡∏∏‡πà‡∏° "‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô"
    const centerBtn = document.getElementById('centerMapBtn');
    if (centerBtn) {
        // ‡πÅ‡∏ó‡∏£‡∏Å‡∏´‡∏•‡∏±‡∏á centerBtn
        centerBtn.parentNode.insertBefore(routeBtn, centerBtn.nextSibling);
    } else {
        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏°‡∏µ centerBtn ‡πÉ‡∏´‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ó‡∏µ‡πà‡∏ó‡πâ‡∏≤‡∏¢
        controlBar.appendChild(routeBtn);
    }
    
    console.log('‚úÖ Route button created successfully');
},
    
  clearSelection() {
    console.log('üóëÔ∏è Clearing all selections...');
    
    // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    const allCheckboxes = document.querySelectorAll('.google-student-checkbox');
    allCheckboxes.forEach(checkbox => {
        checkbox.checked = false;
    });
    
    // ‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï dropdown ‡πÄ‡∏õ‡πá‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
    const routeTypeEl = document.getElementById('googleRouteType');
    if (routeTypeEl) {
        routeTypeEl.value = 'custom'; // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô custom ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÑ‡∏°‡πà‡πÉ‡∏´‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥
    }
    
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï summary
    this.updateRouteSummary();
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
    this.showToast('‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÅ‡∏•‡πâ‡∏ß', 'info');
    
    console.log('‚úÖ All selections cleared');
},
  
    // ‡πÅ‡∏™‡∏î‡∏á Modal ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
    showRoutePlanningModal() {
        this.removeExistingModal();
        this.createRoutePlanningModal();
        this.populateStudentList();
        
        const modal = new bootstrap.Modal(document.getElementById('routePlanningGoogleModal'));
        modal.show();
    },
    
    // ‡∏•‡∏ö Modal ‡πÄ‡∏î‡∏¥‡∏° (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    removeExistingModal() {
        const existingModal = document.getElementById('routePlanningGoogleModal');
        if (existingModal) {
            existingModal.remove();
        }
    },
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á Modal
   createRoutePlanningModal() {
    const modalHTML = `
        <div class="modal fade" id="routePlanningGoogleModal" tabindex="-1" aria-labelledby="routePlanningGoogleModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-xl">
                <div class="modal-content">
                    <div class="modal-header bg-success text-white">
                        <h5 class="modal-title" id="routePlanningGoogleModalLabel">
                            <i class="fab fa-google"></i> ‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏î‡πâ‡∏ß‡∏¢ Google Maps
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <!-- ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥ -->
                        <div class="alert alert-info">
                            <i class="fas fa-info-circle"></i>
                            <strong>‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥:</strong> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡∏•‡∏¥‡∏Å "‡πÄ‡∏õ‡∏¥‡∏î Google Maps" 
                            ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô Google Maps ‡∏û‡∏£‡πâ‡∏≠‡∏° turn-by-turn navigation
                        </div>

                        <!-- Real-time Summary Bar -->
                        <div id="googleRouteSummary" class="alert alert-light border" style="display: none;">
                            <div class="row text-center">
                                <div class="col-3">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <i class="fas fa-home text-primary me-2"></i>
                                        <div>
                                            <div class="h4 text-primary mb-0" id="selectedCount">0</div>
                                            <small class="text-muted">‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <i class="fas fa-route text-success me-2"></i>
                                        <div>
                                            <div class="h4 text-success mb-0" id="estimatedDistance">0</div>
                                            <small class="text-muted">‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <i class="fas fa-clock text-info me-2"></i>
                                        <div>
                                            <div class="h4 text-info mb-0" id="estimatedTime">0</div>
                                            <small class="text-muted">‡∏ô‡∏≤‡∏ó‡∏µ</small>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-3">
                                    <div class="d-flex align-items-center justify-content-center">
                                        <i class="fas fa-car text-warning me-2"></i>
                                        <div>
                                            <div class="h5 text-warning mb-0" id="travelModeDisplay">üöó</div>
                                            <small class="text-muted">‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="progress mt-2" style="height: 8px;">
                                <div class="progress-bar bg-success" role="progressbar" id="selectionProgress" style="width: 0%"></div>
                            </div>
                            <div class="text-center mt-2">
                                <small class="text-muted" id="summaryStatus">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</small>
                            </div>
                        </div>

                        <div class="row">
                            <!-- ‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
                            <div class="col-md-4">
                                <div class="card">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-cogs"></i> ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</h6>
                                    </div>
                                    <div class="card-body">
                                        <!-- ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° -->
                                        <div class="mb-3">
                                            <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°:</label>
                                            <select id="googleRouteType" class="form-select form-select-sm">
                                                <option value="notVisited">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° (‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥)</option>
                                                <option value="priority">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏π‡∏á</option>
                                                <option value="nearSchool">‡πÉ‡∏Å‡∏•‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                                <option value="all">‡∏ó‡∏∏‡∏Å‡πÄ‡∏Ñ‡∏™</option>
                                                <option value="custom">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏≠‡∏á</option>
                                            </select>
                                        </div>
                                        
                                        <!-- ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î -->
                                        <div class="mb-3">
                                            <label class="form-label">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î:</label>
                                            <select id="googleMaxVisits" class="form-select form-select-sm">
                                                <option value="5">5 ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô</option>
                                                <option value="10" selected>10 ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô</option>
                                                <option value="15">15 ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô</option>
                                                <option value="20">20 ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô</option>
                                                <option value="25">25 ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô</option>
                                            </select>
                                            <small class="text-muted">Google Maps ‡∏£‡∏≠‡∏á‡∏£‡∏±‡∏ö‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 25 ‡∏à‡∏∏‡∏î</small>
                                        </div>
                                        
                                        <!-- ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á -->
                                        <div class="mb-3">
                                            <label class="form-label">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á:</label>
                                            <select id="googleTravelMode" class="form-select form-select-sm">
                                                <option value="driving">üöó ‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ</option>
                                                <option value="walking">üö∂ ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤</option>
                                                <option value="bicycling">üö¥ ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô</option>
                                                <option value="transit">üöå ‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞</option>
                                            </select>
                                        </div>
                                        
                                        <!-- ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏° -->
                                        <div class="mb-3">
                                            <label class="form-label">‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°:</label>
                                            <select id="googleSortBy" class="form-select form-select-sm">
                                                <option value="distance">‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î</option>
                                                <option value="priority">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</option>
                                                <option value="class">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</option>
                                                <option value="name">‡∏ä‡∏∑‡πà‡∏≠ A-Z</option>
                                            </select>
                                        </div>
                                        
                                        <!-- ‡∏õ‡∏∏‡πà‡∏°‡∏Ñ‡∏ß‡∏ö‡∏Ñ‡∏∏‡∏° -->
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-primary btn-sm" onclick="RoutePlanningGoogle.generateGoogleRoute()" id="generateRouteBtn" disabled>
                                                <i class="fab fa-google"></i> ‡πÄ‡∏õ‡∏¥‡∏î Google Maps
                                            </button>
                                            <button type="button" class="btn btn-outline-info btn-sm" onclick="RoutePlanningGoogle.previewRoute()" id="previewRouteBtn" disabled>
                                                <i class="fas fa-eye"></i> ‡∏î‡∏π‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" onclick="RoutePlanningGoogle.clearSelection()">
                                                <i class="fas fa-trash"></i> ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
                                            </button>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- Quick Actions -->
                                <div class="card mt-3">
                                    <div class="card-header">
                                        <h6 class="mb-0"><i class="fas fa-bolt"></i> ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏î‡πà‡∏ß‡∏ô</h6>
                                    </div>
                                    <div class="card-body">
                                        <div class="d-grid gap-2">
                                            <button type="button" class="btn btn-outline-danger btn-sm" onclick="RoutePlanningGoogle.quickRoute('urgent')">
                                                <i class="fas fa-exclamation-triangle"></i> ‡πÄ‡∏Ñ‡∏™‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô (5 ‡∏Ñ‡∏ô)
                                            </button>
                                            <button type="button" class="btn btn-outline-warning btn-sm" onclick="RoutePlanningGoogle.quickRoute('nearby')">
                                                <i class="fas fa-map-marker-alt"></i> ‡πÉ‡∏Å‡∏•‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (10 ‡∏Ñ‡∏ô)
                                            </button>
                                            <button type="button" class="btn btn-outline-success btn-sm" onclick="RoutePlanningGoogle.quickRoute('notVisited')">
                                                <i class="fas fa-list-check"></i> ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° (15 ‡∏Ñ‡∏ô)
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô -->
                            <div class="col-md-8">
                                <div class="card">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h6 class="mb-0"><i class="fas fa-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h6>
                                        <div class="d-flex align-items-center">
                                            <span class="badge bg-primary me-2" id="totalStudentCount">0</span>
                                            <div class="btn-group" role="group">
                                                <button type="button" class="btn btn-outline-primary btn-sm" onclick="RoutePlanningGoogle.selectAll()">
                                                    <i class="fas fa-check-square"></i> ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                                </button>
                                                <button type="button" class="btn btn-outline-secondary btn-sm" onclick="RoutePlanningGoogle.unselectAll()">
                                                    <i class="fas fa-square"></i> ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏™‡πà‡∏ß‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤ -->
                                    <div class="card-body pb-2">
                                        <div class="input-group input-group-sm mb-3">
                                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                                            <input type="text" id="googleStudentSearch" class="form-control" placeholder="‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•, ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô, ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...">
                                            <button class="btn btn-outline-secondary" type="button" onclick="RoutePlanningGoogle.clearSearch()">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="card-body pt-0" style="max-height: 500px; overflow-y: auto;">
                                        <div id="googleStudentListContainer">
                                            <div class="text-center">
                                                <div class="spinner-border spinner-border-sm" role="status"></div>
                                                <small class="ms-2">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£...</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <div class="d-flex justify-content-between w-100">
                            <div>
                                <small class="text-muted">
                                    <i class="fas fa-info-circle"></i> 
                                    Google Maps ‡∏à‡∏∞‡πÄ‡∏õ‡∏¥‡∏î‡πÉ‡∏ô‡πÅ‡∏ó‡πá‡∏ö‡πÉ‡∏´‡∏°‡πà‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°
                                </small>
                            </div>
                            <div>
                                <button type="button" class="btn btn-outline-info" onclick="RoutePlanningGoogle.shareRoute()" id="shareRouteBtn" disabled>
                                    <i class="fas fa-share"></i> ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
                                </button>
                                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                    <i class="fas fa-times"></i> ‡∏õ‡∏¥‡∏î
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.body.insertAdjacentHTML('beforeend', modalHTML);
    
    // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ event listeners ‡∏û‡∏£‡πâ‡∏≠‡∏° real-time updates
    this.setupModalEventListeners();
},
    
  // ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Event Listeners ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Real-time Updates
setupModalEventListeners() {
    // Route Type Change
    const routeTypeEl = document.getElementById('googleRouteType');
    if (routeTypeEl) {
        routeTypeEl.addEventListener('change', () => {
            this.onRouteTypeChanged();
            this.updateRouteSummary();
        });
    }
    
    // Max Visits Change
    const maxVisitsEl = document.getElementById('googleMaxVisits');
    if (maxVisitsEl) {
        maxVisitsEl.addEventListener('change', () => {
            this.updateRouteSummary();
            this.validateSelection();
        });
    }
    
    // Travel Mode Change
    const travelModeEl = document.getElementById('googleTravelMode');
    if (travelModeEl) {
        travelModeEl.addEventListener('change', () => {
            this.updateTravelModeDisplay();
            this.updateRouteSummary();
        });
    }
    
    // Sort By Change
    const sortByEl = document.getElementById('googleSortBy');
    if (sortByEl) {
        sortByEl.addEventListener('change', () => {
            this.sortStudentList();
        });
    }
    
    // Search Input
    const searchEl = document.getElementById('googleStudentSearch');
    if (searchEl) {
        searchEl.addEventListener('input', (e) => {
            this.searchStudents(e.target.value);
        });
        
        // Clear search on escape
        searchEl.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                this.clearSearch();
            }
        });
    }
    
    // Show summary on modal open
    const modal = document.getElementById('routePlanningGoogleModal');
    if (modal) {
        modal.addEventListener('shown.bs.modal', () => {
            document.getElementById('googleRouteSummary').style.display = 'block';
            this.updateRouteSummary();
        });
    }
},

  
  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Å‡∏≤‡∏£‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
updateTravelModeDisplay() {
    const travelModeEl = document.getElementById('googleTravelMode');
    const displayEl = document.getElementById('travelModeDisplay');
    
    if (!travelModeEl || !displayEl) return;
    
    const modes = {
        'driving': 'üöó',
        'walking': 'üö∂',
        'bicycling': 'üö¥',
        'transit': 'üöå'
    };
    
    displayEl.textContent = modes[travelModeEl.value] || 'üöó';
},
  
// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°
validateSelection() {
    const selectedCount = this.getSelectedStudentsCount();
    const maxVisits = parseInt(document.getElementById('googleMaxVisits')?.value) || 25;
    
    // Enable/Disable buttons based on selection
    const generateBtn = document.getElementById('generateRouteBtn');
    const previewBtn = document.getElementById('previewRouteBtn');
    const shareBtn = document.getElementById('shareRouteBtn');
    
    const isValidSelection = selectedCount > 0 && selectedCount <= maxVisits;
    
    if (generateBtn) generateBtn.disabled = !isValidSelection;
    if (previewBtn) previewBtn.disabled = !isValidSelection;
    if (shareBtn) shareBtn.disabled = !isValidSelection;
    
    return isValidSelection;
},  
  
// ‡∏ô‡∏±‡∏ö‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
getSelectedStudentsCount() {
    const visibleCheckedBoxes = Array.from(document.querySelectorAll('.google-student-checkbox:checked')).filter(checkbox => {
        const parentItem = checkbox.closest('.google-student-item');
        return parentItem && 
               parentItem.style.display !== 'none' && 
               parentItem.offsetParent !== null;
    });
    return visibleCheckedBoxes.length;
},  
    // ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    populateStudentList() {
        const container = document.getElementById('googleStudentListContainer');
        const totalCountEl = document.getElementById('totalStudentCount');
        
        if (!container) return;
        
        if (!homeVisitData || homeVisitData.length === 0) {
            container.innerHTML = '<div class="text-muted text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</div>';
            if (totalCountEl) totalCountEl.textContent = '0';
            return;
        }
        
        // ‡∏Å‡∏£‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î
        const studentsWithCoords = homeVisitData.filter(student => {
            return student && student['LatLongHome'] && student['LatLongHome'].includes(',');
        });
        
        if (studentsWithCoords.length === 0) {
            container.innerHTML = '<div class="text-muted text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà</div>';
            if (totalCountEl) totalCountEl.textContent = '0';
            return;
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        if (totalCountEl) {
            totalCountEl.textContent = studentsWithCoords.length;
        }
        
        this.renderStudentList(studentsWithCoords);
    },
    
    // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
     searchStudents(searchTerm) {
        const items = document.querySelectorAll('.google-student-item');
        const term = searchTerm.toLowerCase().trim();
        
        let visibleCount = 0;
        
        items.forEach(item => {
            const index = parseInt(item.dataset.index);
            if (isNaN(index) || !homeVisitData[index]) {
                item.style.display = 'none';
                return;
            }
            
            const student = homeVisitData[index];
            const name = (student['‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '').toLowerCase();
            const nickname = (student['‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô'] || '').toLowerCase();
            const classroom = (student['‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] || '').toLowerCase();
            
            // ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÉ‡∏ô‡∏ä‡∏∑‡πà‡∏≠, ‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏•‡πà‡∏ô, ‡∏´‡∏£‡∏∑‡∏≠‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
            const isMatch = term === '' || 
                           name.includes(term) || 
                           nickname.includes(term) || 
                           classroom.includes(term);
            
            item.style.display = isMatch ? 'block' : 'none';
            if (isMatch) visibleCount++;
        });
        
        console.log(`üîç Search results: ${visibleCount} items visible for term: "${term}"`);
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏•‡∏±‡∏á‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
        setTimeout(() => this.updateRouteSummary(), 100);
    },
    
    // ‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤
    clearSearch() {
        const searchInput = document.getElementById('googleStudentSearch');
        if (searchInput) {
            searchInput.value = '';
            this.searchStudents(''); // ‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
        }
    },
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    renderStudentList(students) {
        const container = document.getElementById('googleStudentListContainer');
        
        const studentListHTML = students.map((student, index) => {
            const isVisited = student['‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°'] === '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß';
            const distance = student.distanceFromSchool ? 
                `${student.distanceFromSchool.toFixed(1)} ‡∏Å‡∏°.` : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö';
            
            const statusBadge = isVisited ? 
                '<span class="badge bg-success">‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß</span>' : 
                '<span class="badge bg-danger">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</span>';
            
            // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
            const priorityScore = this.calculatePriorityScore(student);
            const priorityBadge = priorityScore >= 6 ? 
                '<span class="badge bg-warning">‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</span>' : '';
            
            // ‡∏´‡∏≤ index ‡πÉ‡∏ô homeVisitData
            const originalIndex = homeVisitData.findIndex(s => 
                s['‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] === student['‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] && 
                s['‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] === student['‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô']
            );
            
            return `
                <div class="form-check border rounded p-2 mb-2 google-student-item" data-index="${originalIndex}" data-priority="${priorityScore}">
                    <input class="form-check-input google-student-checkbox" type="checkbox" value="${originalIndex}" id="google_student_${originalIndex}" ${!isVisited ? 'checked' : ''}>
                    <label class="form-check-label w-100" for="google_student_${originalIndex}">
                        <div class="d-flex justify-content-between align-items-center">
                            <div>
                                <strong>${student['‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</strong>
                                <small class="text-muted d-block">${student['‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] || ''} ‚Ä¢ ${distance}</small>
                            </div>
                            <div class="text-end">
                                ${statusBadge}
                                ${priorityBadge}
                            </div>
                        </div>
                    </label>
                </div>
            `;
        }).join('');
        
        container.innerHTML = studentListHTML;
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡πÉ‡∏´‡∏°‡πà
        this.bindCheckboxEvents();
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡πÅ‡∏•‡∏∞‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ
        setTimeout(() => {
            this.sortStudentList();
        }, 100);
    },
    
  
  // ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÅ‡∏¢‡∏Å‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö bind events
    bindCheckboxEvents() {
        // ‡∏•‡∏ö event listeners ‡πÄ‡∏Å‡πà‡∏≤ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
        document.querySelectorAll('.google-student-checkbox').forEach(checkbox => {
            checkbox.removeEventListener('change', this.handleCheckboxChange);
        });
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° event listeners ‡πÉ‡∏´‡∏°‡πà
        document.querySelectorAll('.google-student-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', this.handleCheckboxChange.bind(this));
        });
    },
  
   // Handle checkbox change event
    handleCheckboxChange(event) {
        const checkbox = event.target;
        console.log(`üìù Checkbox ${checkbox.value} changed to:`, checkbox.checked);
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
        this.updateRouteSummary();
    },

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç
    calculatePriorityScore(student) {
        let priority = 0;
        
        // ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°
        if (student['‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°'] !== '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß') priority += 3;
        
        // ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≥
        const income = student['‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ'] ? parseFloat(student['‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ'].replace(/[‡∏ø,]/g, '')) : 0;
        if (income > 0 && income < 5000) priority += 3;
        else if (income >= 5000 && income < 10000) priority += 2;
        else if (income >= 10000 && income < 15000) priority += 1;
        
        // ‡πÑ‡∏î‡πâ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£
        if (student['‡πÑ‡∏î‡πâ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏´‡πà‡∏á‡∏£‡∏±‡∏ê'] === 'TRUE') priority += 1;
        
        // ‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏∞‡∏û‡∏∂‡πà‡∏á‡∏û‡∏¥‡∏á
        if (student['‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡∏°‡∏µ‡∏†‡∏≤‡∏£‡∏∞‡∏û‡∏∂‡πà‡∏á‡∏û‡∏¥‡∏á']) priority += 1;
        
        // ‡πÑ‡∏Å‡∏•‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        if (student.distanceFromSchool && student.distanceFromSchool > 5) priority += 2;
        else if (student.distanceFromSchool && student.distanceFromSchool > 3) priority += 1;
        
        return priority;
    },
    
    // ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°
 onRouteTypeChanged() {
        const routeTypeEl = document.getElementById('googleRouteType');
        if (!routeTypeEl) return;
        
        const routeType = routeTypeEl.value;
        console.log('üîÑ Route type changed to:', routeType);
        
        const checkboxes = document.querySelectorAll('.google-student-checkbox');
        
        checkboxes.forEach((checkbox, index) => {
            const studentIndex = parseInt(checkbox.value);
            if (isNaN(studentIndex) || !homeVisitData[studentIndex]) return;
            
            const student = homeVisitData[studentIndex];
            let shouldCheck = false;
            
            switch (routeType) {
                case 'all':
                    shouldCheck = true;
                    break;
                case 'notVisited':
                    shouldCheck = student['‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°'] !== '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß';
                    break;
                case 'priority':
                    shouldCheck = this.calculatePriorityScore(student) >= 4;
                    break;
                case 'nearSchool':
                    shouldCheck = student.distanceFromSchool && student.distanceFromSchool < 3;
                    break;
                case 'custom':
                    return; // ‡πÑ‡∏°‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏≠‡∏∞‡πÑ‡∏£
            }
            
            checkbox.checked = shouldCheck;
        });
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó
        setTimeout(() => this.updateRouteSummary(), 100);
    },
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    sortStudentList() {
        const sortByEl = document.getElementById('googleSortBy');
        const container = document.getElementById('googleStudentListContainer');
        
        if (!sortByEl || !container) return;
        
        const sortBy = sortByEl.value;
        const items = Array.from(container.querySelectorAll('.google-student-item'));
        
        items.sort((a, b) => {
            const indexA = parseInt(a.dataset.index);
            const indexB = parseInt(b.dataset.index);
            
            if (isNaN(indexA) || isNaN(indexB) || !homeVisitData[indexA] || !homeVisitData[indexB]) {
                return 0;
            }
            
            const studentA = homeVisitData[indexA];
            const studentB = homeVisitData[indexB];
            
            switch (sortBy) {
                case 'distance':
                    return (studentA.distanceFromSchool || 999) - (studentB.distanceFromSchool || 999);
                case 'priority':
                    return parseInt(b.dataset.priority || 0) - parseInt(a.dataset.priority || 0);
                case 'class':
                    return (studentA['‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] || '').localeCompare(studentB['‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] || '');
                case 'name':
                    return (studentA['‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '').localeCompare(studentB['‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '');
                default:
                    return 0;
            }
        });
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡∏°‡πà‡πÉ‡∏ô DOM
        items.forEach(item => container.appendChild(item));
    },
    
// ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á - Enhanced Version
updateRouteSummary() {
    const selectedCountEl = document.getElementById('selectedCount');
    const estimatedDistanceEl = document.getElementById('estimatedDistance');
    const estimatedTimeEl = document.getElementById('estimatedTime');
    const summaryDiv = document.getElementById('googleRouteSummary');
    const progressBar = document.getElementById('selectionProgress');
    const statusEl = document.getElementById('summaryStatus');
    const maxVisitsEl = document.getElementById('googleMaxVisits');
    
    // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ modal ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏¢‡∏π‡πà
    const modal = document.getElementById('routePlanningGoogleModal');
    if (!modal || !modal.classList.contains('show')) return;
    
    if (!selectedCountEl || !estimatedDistanceEl || !estimatedTimeEl || !summaryDiv) return;
    
    try {
        const selectedCount = this.getSelectedStudentsCount();
        const maxVisits = parseInt(maxVisitsEl?.value) || 25;
        
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡πÄ‡∏ß‡∏•‡∏≤
        let totalDistance = 0;
        let validStudents = 0;
        
        if (selectedCount > 0) {
            const checkedBoxes = Array.from(document.querySelectorAll('.google-student-checkbox:checked')).filter(checkbox => {
                const parentItem = checkbox.closest('.google-student-item');
                return parentItem && 
                       parentItem.style.display !== 'none' && 
                       parentItem.offsetParent !== null;
            });
            
            checkedBoxes.forEach(checkbox => {
                const index = parseInt(checkbox.value);
                if (!isNaN(index) && homeVisitData && homeVisitData[index]) {
                    const student = homeVisitData[index];
                    totalDistance += parseFloat(student.distanceFromSchool) || 0;
                    validStudents++;
                }
            });
        }
        
        const estimatedTime = (validStudents * 30) + (totalDistance * 3);
        const progressPercent = Math.min((selectedCount / maxVisits) * 100, 100);
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï UI
        selectedCountEl.textContent = selectedCount.toString();
        estimatedDistanceEl.textContent = totalDistance.toFixed(1);
        estimatedTimeEl.textContent = Math.round(estimatedTime).toString();
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï progress bar
        if (progressBar) {
            progressBar.style.width = progressPercent + '%';
            
            // ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏™‡∏µ‡∏ï‡∏≤‡∏°‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
            progressBar.className = 'progress-bar';
            if (selectedCount > maxVisits) {
                progressBar.classList.add('bg-danger');
            } else if (selectedCount > maxVisits * 0.8) {
                progressBar.classList.add('bg-warning');
            } else {
                progressBar.classList.add('bg-success');
            }
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞
        if (statusEl) {
            if (selectedCount === 0) {
                statusEl.textContent = '‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏≤‡∏á‡πÅ‡∏ú‡∏ô‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á';
                statusEl.className = 'text-muted';
            } else if (selectedCount > maxVisits) {
                statusEl.textContent = `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Å‡∏¥‡∏ô‡∏Ç‡∏µ‡∏î‡∏à‡∏≥‡∏Å‡∏±‡∏î! (${selectedCount}/${maxVisits})`;
                statusEl.className = 'text-danger';
            } else {
                statusEl.textContent = `‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á (${selectedCount}/${maxVisits})`;
                statusEl.className = 'text-success';
            }
        }
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏µ summary
        if (selectedCount > maxVisits) {
            summaryDiv.className = 'alert alert-warning border';
        } else if (selectedCount > 0) {
            summaryDiv.className = 'alert alert-light border border-success';
        } else {
            summaryDiv.className = 'alert alert-light border';
        }
        
        // ‡πÄ‡∏õ‡∏¥‡∏î/‡∏õ‡∏¥‡∏î‡∏õ‡∏∏‡πà‡∏°
        this.validateSelection();
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï travel mode display
        this.updateTravelModeDisplay();
        
        console.log(`‚úÖ Summary updated: ${selectedCount} students, ${totalDistance.toFixed(1)}km, ${Math.round(estimatedTime)}min`);
        
    } catch (error) {
        console.error('‚ùå Error updating route summary:', error);
    }
},
    
    // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
selectAll() {
        const maxVisitsEl = document.getElementById('googleMaxVisits');
        if (!maxVisitsEl) return;
        
        const maxVisits = parseInt(maxVisitsEl.value) || 25;
        const visibleCheckboxes = Array.from(document.querySelectorAll('.google-student-checkbox')).filter(checkbox => {
            const parentItem = checkbox.closest('.google-student-item');
            return parentItem && 
                   parentItem.style.display !== 'none' && 
                   parentItem.offsetParent !== null;
        });
        
        let count = 0;
        visibleCheckboxes.forEach(checkbox => {
            if (count < maxVisits) {
                checkbox.checked = true;
                count++;
            } else {
                checkbox.checked = false;
            }
        });
        
        console.log(`‚úÖ Selected ${count} students out of ${maxVisits} max`);
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ
        setTimeout(() => this.updateRouteSummary(), 100);
    },
    
    // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
unselectAll() {
        const visibleCheckboxes = Array.from(document.querySelectorAll('.google-student-checkbox')).filter(checkbox => {
            const parentItem = checkbox.closest('.google-student-item');
            return parentItem && 
                   parentItem.style.display !== 'none' && 
                   parentItem.offsetParent !== null;
        });
        
        visibleCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        
        console.log('üóëÔ∏è Unselected all visible students');
        
        // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏™‡∏£‡∏∏‡∏õ
        setTimeout(() => this.updateRouteSummary(), 100);
    },
    
    // ‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏î‡πà‡∏ß‡∏ô
    quickRoute(type) {
        // ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏Å‡πà‡∏≠‡∏ô
        this.unselectAll();
        
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ checkbox ‡∏ó‡∏µ‡πà‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏¢‡∏π‡πà
        const visibleCheckboxes = Array.from(document.querySelectorAll('.google-student-checkbox')).filter(checkbox => {
            const parentItem = checkbox.closest('.google-student-item');
            return parentItem && parentItem.style.display !== 'none';
        });
        
        let limits = { urgent: 5, nearby: 10, notVisited: 15 };
        let count = 0;
        
        visibleCheckboxes.forEach(checkbox => {
            if (count >= limits[type]) return;
            
            const studentIndex = parseInt(checkbox.value);
            if (isNaN(studentIndex) || !homeVisitData[studentIndex]) return;
            
            const student = homeVisitData[studentIndex];
            let shouldSelect = false;
            
            switch (type) {
                case 'urgent':
                    shouldSelect = this.calculatePriorityScore(student) >= 6;
                    break;
                case 'nearby':
                    shouldSelect = student.distanceFromSchool && student.distanceFromSchool < 3;
                    break;
                case 'notVisited':
                    shouldSelect = student['‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°'] !== '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß';
                    break;
            }
            
            if (shouldSelect) {
                checkbox.checked = true;
                count++;
            }
        });
        
        this.updateRouteSummary();
        
        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô
        const messages = {
            urgent: `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏Ñ‡∏™‡πÄ‡∏£‡πà‡∏á‡∏î‡πà‡∏ß‡∏ô ${count} ‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß`,
            nearby: `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏Å‡∏•‡πâ‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${count} ‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß`,
            notVisited: `‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° ${count} ‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß`
        };
        
        this.showToast(messages[type], 'success');
    },
 ///////////////////////////////////////   
// Enhanced previewRoute - Simple & Clean Design ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π
previewRoute() {
    const selectedStudents = this.getSelectedStudents();
    if (selectedStudents.length === 0) {
        this.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏Å‡πà‡∏≠‡∏ô', 'warning');
        return;
    }
    
    console.log('üîç Creating clean preview for', selectedStudents.length, 'students');
    
    const previewUrl = this.generateGoogleMapsUrl(selectedStudents, true);
    const totalDistance = selectedStudents.reduce((sum, student) => {
        return sum + (student.distanceFromSchool || 0);
    }, 0);
    const estimatedTime = selectedStudents.length * 30 + totalDistance * 3;
    
    // ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà
    const previewWindow = window.open('', '_blank', 'width=1000,height=700,scrollbars=yes,resizable=yes');
    
    if (!previewWindow) {
        this.showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏õ‡∏¥‡∏î‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï popup', 'error');
        return;
    }
    
    previewWindow.document.open();
    previewWindow.document.write(this.generateCleanPreviewHTML(selectedStudents, previewUrl, totalDistance, estimatedTime));
    previewWindow.document.close();
    
    console.log('‚úÖ Clean preview window created successfully');
},

// ‡∏™‡∏£‡πâ‡∏≤‡∏á HTML ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢
generateCleanPreviewHTML(selectedStudents, previewUrl, totalDistance, estimatedTime) {
    return `
        <!DOCTYPE html>
        <html lang="th">
            <head>
                <meta charset="UTF-8">
                <meta name="viewport" content="width=device-width, initial-scale=1.0">
                <title>‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</title>
                <link rel="preconnect" href="https://fonts.googleapis.com">
                <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
                <link href="https://fonts.googleapis.com/css2?family=Google+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
                <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
                <style>
                    ${this.getCleanPreviewCSS()}
                </style>
            </head>
            <body>
                <div class="container">
                    <!-- Header -->
                    <div class="header">
                        <div class="header-content">
                            <h1><i class="fas fa-route"></i> ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h1>
                            <p class="date">${new Date().toLocaleDateString('th-TH', { 
                                year: 'numeric', 
                                month: 'long', 
                                day: 'numeric',
                                weekday: 'long'
                            })}</p>
                        </div>
                        
                        <!-- Quick Actions -->
                        <div class="actions no-print">
                            <button class="btn btn-primary" onclick="window.print()">
                                <i class="fas fa-print"></i> ‡∏û‡∏¥‡∏°‡∏û‡πå
                            </button>
                            <a href="${previewUrl}" target="_blank" class="btn btn-success">
                                <i class="fab fa-google"></i> Google Maps
                            </a>
                            <button class="btn btn-secondary" onclick="window.close()">
                                <i class="fas fa-times"></i> ‡∏õ‡∏¥‡∏î
                            </button>
                        </div>
                    </div>

                    <!-- Summary -->
                    <div class="summary">
                        <div class="summary-item">
                            <i class="fas fa-home"></i>
                            <div>
                                <span class="number">${selectedStudents.length}</span>
                                <span class="label">‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô</span>
                            </div>
                        </div>
                        <div class="summary-item">
                            <i class="fas fa-road"></i>
                            <div>
                                <span class="number">${totalDistance.toFixed(1)}</span>
                                <span class="label">‡∏Å‡∏¥‡πÇ‡∏•‡πÄ‡∏°‡∏ï‡∏£</span>
                            </div>
                        </div>
                        <div class="summary-item">
                            <i class="fas fa-clock"></i>
                            <div>
                                <span class="number">${Math.floor(estimatedTime / 60)}:${String(estimatedTime % 60).padStart(2, '0')}</span>
                                <span class="label">‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á:‡∏ô‡∏≤‡∏ó‡∏µ</span>
                            </div>
                        </div>
                        <div class="summary-item">
                            <i class="fas fa-car"></i>
                            <div>
                                <span class="number">${this.getTravelModeText()}</span>
                                <span class="label">‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á</span>
                            </div>
                        </div>
                    </div>

                    <!-- Teacher Tips -->
                    <div class="tips-section">
                        <h2><i class="fas fa-lightbulb"></i> ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô</h2>
                        <div class="tips-grid">
                            ${this.generateTeacherTips()}
                        </div>
                    </div>

                    <!-- Emergency Contacts -->
                    <div class="emergency-section">
                        <h2><i class="fas fa-phone"></i> ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô</h2>
                        <div class="emergency-grid">
                            ${this.generateEmergencyContacts()}
                        </div>
                    </div>

                    <!-- Visit Preparation -->
                    <div class="preparation-section">
                        <h2><i class="fas fa-clipboard-list"></i> ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°</h2>
                        <div class="checklist">
                            ${this.generatePreparationChecklist()}
                        </div>
                    </div>

                    <!-- Students List -->
                    <div class="students-section">
                        <h2><i class="fas fa-users"></i> ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (${selectedStudents.length} ‡∏Ñ‡∏ô)</h2>
                        <div class="students-table">
                            ${this.generateStudentsTable(selectedStudents)}
                        </div>
                    </div>

                    <!-- Route Timeline -->
                    <div class="timeline-section">
                        <h2><i class="fas fa-route"></i> ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á)</h2>
                        <div class="timeline">
                            ${this.generateOptimizedRouteTimeline(selectedStudents)}
                        </div>
                    </div>

                    <!-- Footer -->
                    <div class="footer">
                        <p>‡∏û‡∏¥‡∏°‡∏û‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠: ${new Date().toLocaleString('th-TH')} | ‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏≤‡∏£‡∏™‡∏ô‡πÄ‡∏ó‡∏®‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>
                    </div>
                </div>

                <script>
                    ${this.getCleanPreviewScript()}
                </script>
            </body>
        </html>
    `;
},

// CSS ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢
getCleanPreviewCSS() {
    return `
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Google Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            line-height: 1.6;
            color: #333;
            background: #f8f9fa;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            min-height: 100vh;
        }

        /* Header */
        .header {
            background: #1a73e8;
            color: white;
            padding: 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .header-content h1 {
            font-size: 1.8rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }

        .header-content h1 i {
            margin-right: 0.5rem;
        }

        .date {
            opacity: 0.9;
            font-size: 1rem;
        }

        .actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            font-weight: 500;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: #34a853;
            color: white;
        }

        .btn-success {
            background: #fbbc04;
            color: #333;
        }

        .btn-secondary {
            background: #ea4335;
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }

        /* Summary */
        .summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            padding: 2rem;
            background: #f8f9fa;
            border-bottom: 1px solid #e9ecef;
        }

        .summary-item {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
            background: white;
            border-radius: 8px;
            border-left: 4px solid #1a73e8;
        }

        .summary-item i {
            font-size: 1.5rem;
            color: #1a73e8;
        }

        .number {
            display: block;
            font-size: 1.5rem;
            font-weight: 600;
            line-height: 1;
        }

        .label {
            font-size: 0.9rem;
            color: #666;
        }

        /* Sections */
        .tips-section,
        .emergency-section,
        .preparation-section,
        .students-section,
        .timeline-section {
            padding: 2rem;
            border-bottom: 1px solid #e9ecef;
        }

        h2 {
            font-size: 1.3rem;
            font-weight: 500;
            margin-bottom: 1.5rem;
            color: #333;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        h2 i {
            color: #1a73e8;
        }

        /* Tips Grid */
        .tips-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1rem;
        }

        .tip-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 3px solid #34a853;
        }

        .tip-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
            color: #333;
        }

        .tip-content {
            font-size: 0.9rem;
            color: #666;
        }

        /* Emergency Contacts */
        .emergency-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .emergency-item {
            background: #fff3cd;
            padding: 1rem;
            border-radius: 6px;
            border: 1px solid #ffeaa7;
        }

        .emergency-title {
            font-weight: 600;
            color: #856404;
            margin-bottom: 0.5rem;
        }

        .emergency-number {
            font-size: 1.1rem;
            font-weight: 600;
            color: #333;
        }

        /* Checklist */
        .checklist {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 0.5rem;
        }

        .checklist-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .checklist-checkbox {
            width: 18px;
            height: 18px;
            border: 2px solid #1a73e8;
            border-radius: 3px;
            cursor: pointer;
        }

        /* Students Table */
        .students-table {
            overflow-x: auto;
        }

        .students-table table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
        }

        .students-table th,
        .students-table td {
            padding: 0.75rem 0.5rem;
            text-align: left;
            border-bottom: 1px solid #e9ecef;
        }

        .students-table th {
            background: #f8f9fa;
            font-weight: 600;
            color: #333;
        }

        .students-table tbody tr:nth-child(even) {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 0.25rem 0.5rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .status-visited {
            background: #d4edda;
            color: #155724;
        }

        .status-not-visited {
            background: #f8d7da;
            color: #721c24;
        }

        .priority-high {
            background: #fff3cd;
            color: #856404;
        }

        /* Assessment Grid */
        .route-optimization {
            background: #e8f5e8;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #34a853;
        }

        .route-optimization h4 {
            color: #1b5e20;
            margin-bottom: 0.5rem;
            font-size: 1rem;
        }

        .route-optimization p {
            color: #2e7d32;
            font-size: 0.9rem;
            margin: 0;
        }

        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 2rem;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: #1a73e8;
        }

        .timeline-item {
            position: relative;
            margin-bottom: 1.5rem;
            background: white;
            padding: 1rem;
            border-radius: 6px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -25px;
            top: 1rem;
            width: 12px;
            height: 12px;
            background: #1a73e8;
            border-radius: 50%;
            border: 3px solid white;
        }

        .timeline-time {
            font-weight: 600;
            color: #1a73e8;
            font-size: 0.9rem;
        }

        .timeline-content {
            margin-top: 0.5rem;
        }

        /* Footer */
        .footer {
            padding: 1rem 2rem;
            background: #f8f9fa;
            text-align: center;
            font-size: 0.8rem;
            color: #666;
        }

        /* Print Styles */
        @media print {
            body {
                background: white;
                font-size: 12px;
            }
            
            .no-print {
                display: none !important;
            }
            
            .container {
                box-shadow: none;
            }
            
            .header {
                background: #1a73e8 !important;
                color: white !important;
            }
            
            .summary {
                background: white !important;
            }
            
            .timeline-item,
            .tip-item,
            .assessment-item {
                page-break-inside: avoid;
            }
            
            h2 {
                page-break-after: avoid;
            }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                text-align: center;
            }
            
            .summary {
                grid-template-columns: 1fr 1fr;
            }
            
            .tips-grid,
            .emergency-grid {
                grid-template-columns: 1fr;
            }
            
            .timeline {
                padding-left: 1rem;
            }
            
            .timeline::before {
                left: 8px;
            }
            
            .timeline-item::before {
                left: -18px;
            }
        }
    `;
},

// ‡πÄ‡∏Ñ‡∏•‡πá‡∏î‡∏•‡∏±‡∏ö‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π
generateTeacherTips() {
    const tips = [
        {
            title: 'üìû ‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤',
            content: '‡πÇ‡∏ó‡∏£‡∏ô‡∏±‡∏î‡∏´‡∏°‡∏≤‡∏¢‡∏Å‡πà‡∏≠‡∏ô‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° 1-2 ‡∏ß‡∏±‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß'
        },
        {
            title: 'üïê ‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°',
            content: '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ä‡πà‡∏ß‡∏á 16:00-18:00 ‡∏ô. ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡∏Å‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏á‡∏≤‡∏ô'
        },
        {
            title: 'üéí ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå',
            content: '‡∏™‡∏°‡∏∏‡∏î‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å, ‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤, ‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°, ‡πÅ‡∏•‡∏∞‡πÅ‡∏ö‡∏ï‡πÄ‡∏ï‡∏≠‡∏£‡∏µ‡πà‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÄ‡∏ï‡πá‡∏°'
        },
        {
            title: 'üë• ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå',
            content: '‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡∏ï‡∏±‡∏ß ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ö‡∏£‡∏£‡∏¢‡∏≤‡∏Å‡∏≤‡∏®‡∏ó‡∏µ‡πà‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô'
        },
        {
            title: 'üëÇ ‡∏ü‡∏±‡∏á‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ï‡∏±‡πâ‡∏á‡πÉ‡∏à',
            content: '‡πÉ‡∏´‡πâ‡∏ú‡∏π‡πâ‡∏õ‡∏Å‡∏Ñ‡∏£‡∏≠‡∏á‡πÄ‡∏•‡πà‡∏≤‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏î‡∏ó‡∏ô'
        },
        {
            title: 'üí° ‡πÉ‡∏´‡πâ‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥',
            content: '‡πÄ‡∏™‡∏ô‡∏≠‡πÅ‡∏ô‡∏ß‡∏ó‡∏≤‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏õ‡∏±‡∏ç‡∏´‡∏≤‡πÅ‡∏ö‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡πÅ‡∏•‡∏∞‡∏õ‡∏è‡∏¥‡∏ö‡∏±‡∏ï‡∏¥‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á'
        }
    ];

    return tips.map(tip => `
        <div class="tip-item">
            <div class="tip-title">${tip.title}</div>
            <div class="tip-content">${tip.content}</div>
        </div>
    `).join('');
},

// ‡πÄ‡∏ö‡∏≠‡∏£‡πå‡∏â‡∏∏‡∏Å‡πÄ‡∏â‡∏¥‡∏ô
generateEmergencyContacts() {
    const contacts = [
        { title: '‡πÇ‡∏£‡∏á‡∏û‡∏¢‡∏≤‡∏ö‡∏≤‡∏•‡πÉ‡∏Å‡∏•‡πâ‡πÄ‡∏Ñ‡∏µ‡∏¢‡∏á', number: '1669' },
        { title: '‡∏ï‡∏≥‡∏£‡∏ß‡∏à', number: '191' },
        { title: '‡∏î‡∏±‡∏ö‡πÄ‡∏û‡∏•‡∏¥‡∏á', number: '199' },
        { title: '‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏î‡πá‡∏Å', number: '1387' },
        { title: '‡∏Ñ‡∏£‡∏π‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏Ñ‡∏£‡∏á‡∏Å‡∏≤‡∏£', number: 'xxx-xxx-xxxx' },
        { title: '‡∏ú‡∏π‡πâ‡∏≠‡∏≥‡∏ô‡∏ß‡∏¢‡∏Å‡∏≤‡∏£', number: '083-664-5989' }
    ];

    return contacts.map(contact => `
        <div class="emergency-item">
            <div class="emergency-title">${contact.title}</div>
            <div class="emergency-number">${contact.number}</div>
        </div>
    `).join('');
},

// ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ï‡∏±‡∏ß
generatePreparationChecklist() {
    const items = [
        '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏•‡πà‡∏ß‡∏á‡∏´‡∏ô‡πâ‡∏≤',
        '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡πÄ‡∏≠‡∏Å‡∏™‡∏≤‡∏£‡∏õ‡∏£‡∏∞‡∏Å‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°',
        '‡∏ä‡∏≤‡∏£‡πå‡∏à‡πÇ‡∏ó‡∏£‡∏®‡∏±‡∏û‡∏ó‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏û‡∏≤‡∏ß‡πÄ‡∏ß‡∏≠‡∏£‡πå‡πÅ‡∏ö‡∏á‡∏Ñ‡πå',
        '‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏≠‡∏ö‡∏Ñ‡∏£‡∏±‡∏ß‡∏ó‡∏£‡∏≤‡∏ö',
        '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏ô‡πâ‡∏≥‡∏î‡∏∑‡πà‡∏°‡πÅ‡∏•‡∏∞‡∏≠‡∏≤‡∏´‡∏≤‡∏£‡πÄ‡∏ö‡∏≤ ‡πÜ',
        '‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏™‡∏†‡∏≤‡∏û‡∏£‡∏ñ‡πÅ‡∏•‡∏∞‡∏ô‡πâ‡∏≥‡∏°‡∏±‡∏ô',
        '‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏´‡∏ô‡πâ‡∏≤‡∏Å‡∏≤‡∏Å‡∏≠‡∏ô‡∏≤‡∏°‡∏±‡∏¢‡πÅ‡∏•‡∏∞‡πÄ‡∏à‡∏•‡∏•‡πâ‡∏≤‡∏á‡∏°‡∏∑‡∏≠',
        '‡∏ô‡∏≥‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡∏´‡∏£‡∏∑‡∏≠ GPS ‡∏™‡∏≥‡∏£‡∏≠‡∏á'
    ];

    return items.map(item => `
        <div class="checklist-item">
            <div class="checklist-checkbox" onclick="toggleCheck(this)"></div>
            <span>${item}</span>
        </div>
    `).join('');
},

// ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
generateStudentsTable(students) {
    const tableRows = students.map((student, index) => {
        const isVisited = student['‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°'] === '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß';
        const priorityScore = this.calculatePriorityScore(student);
        const isHighPriority = priorityScore >= 6;
        
        return `
            <tr>
                <td>${index + 1}</td>
                <td><strong>${student['‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏'}</strong></td>
                <td>${student['‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] || '-'}</td>
                <td>${student.distanceFromSchool ? student.distanceFromSchool.toFixed(1) + ' ‡∏Å‡∏°.' : '-'}</td>
                <td>
                    <span class="status-badge ${isVisited ? 'status-visited' : 'status-not-visited'}">
                        ${isVisited ? '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß' : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°'}
                    </span>
                    ${isHighPriority ? '<span class="status-badge priority-high">‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</span>' : ''}
                </td>
                <td>${this.formatCurrency(student['‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ'])}</td>
                <td>‚ñ° ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß</td>
            </tr>
        `;
    }).join('');

    return `
        <table>
            <thead>
                <tr>
                    <th>‡∏•‡∏≥‡∏î‡∏±‡∏ö</th>
                    <th>‡∏ä‡∏∑‡πà‡∏≠-‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•</th>
                    <th>‡∏´‡πâ‡∏≠‡∏á</th>
                    <th>‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á</th>
                    <th>‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞</th>
                    <th>‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ</th>
                    <th>‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</th>
                </tr>
            </thead>
            <tbody>
                ${tableRows}
            </tbody>
        </table>
    `;
},

// ‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏° (‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á)
generateOptimizedRouteTimeline(students) {
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡πÑ‡∏õ‡πÑ‡∏Å‡∏•
    const sortedStudents = [...students].sort((a, b) => {
        const distanceA = a.distanceFromSchool || 999;
        const distanceB = b.distanceFromSchool || 999;
        return distanceA - distanceB;
    });

    const startTime = new Date();
    startTime.setHours(15, 0, 0, 0); // ‡πÄ‡∏£‡∏¥‡πà‡∏° 15:00

    // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏£‡∏ß‡∏°‡∏ó‡∏µ‡πà‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î
    const totalOptimizedDistance = sortedStudents.reduce((sum, student, index) => {
        if (index === 0) return sum + (student.distanceFromSchool || 0);
        const prevDistance = sortedStudents[index - 1].distanceFromSchool || 0;
        const currentDistance = student.distanceFromSchool || 0;
        return sum + Math.abs(currentDistance - prevDistance);
    }, 0);

    let timeline = `
        <div class="route-optimization">
            <h4><i class="fas fa-route"></i> ‡∏Å‡∏≤‡∏£‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏õ‡∏£‡∏∞‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡∏†‡∏≤‡∏û‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á</h4>
            <p>‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÉ‡∏Å‡∏•‡πâ‡πÑ‡∏õ‡πÑ‡∏Å‡∏• ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì ${Math.round((students.length * 0.8))} ‡∏ô‡∏≤‡∏ó‡∏µ</p>
        </div>
        
        <div class="timeline-item">
            <div class="timeline-time">${startTime.toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}</div>
            <div class="timeline-content">
                <strong>üè´ ‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</strong><br>
                ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡πÅ‡∏•‡∏∞‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á<br>
                <small style="color: #34a853;">üìç ‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏ô‡∏µ‡πâ‡∏õ‡∏£‡∏∞‡∏´‡∏¢‡∏±‡∏î‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á ${totalOptimizedDistance.toFixed(1)} ‡∏Å‡∏°.</small>
            </div>
        </div>
    `;

    let cumulativeTime = 0;
    sortedStudents.forEach((student, index) => {
        // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á (‡∏Ç‡∏∂‡πâ‡∏ô‡∏≠‡∏¢‡∏π‡πà‡∏Å‡∏±‡∏ö‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á)
        const travelTime = index === 0 ? 
            Math.round((student.distanceFromSchool || 0) * 2) : // ‡πÄ‡∏ß‡∏•‡∏≤‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏õ‡∏ö‡πâ‡∏≤‡∏ô‡πÅ‡∏£‡∏Å
            Math.round(Math.abs((student.distanceFromSchool || 0) - (sortedStudents[index - 1].distanceFromSchool || 0)) * 3); // ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏ö‡πâ‡∏≤‡∏ô
        
        const visitTime = 30; // ‡πÄ‡∏ß‡∏•‡∏≤‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° 30 ‡∏ô‡∏≤‡∏ó‡∏µ
        cumulativeTime += travelTime + visitTime;

        const arrivalTime = new Date(startTime);
        arrivalTime.setMinutes(startTime.getMinutes() + cumulativeTime - visitTime);

        const departTime = new Date(arrivalTime);
        departTime.setMinutes(arrivalTime.getMinutes() + visitTime);

        // ‡∏´‡∏≤‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤
        const distanceFromPrevious = index === 0 ? 
            (student.distanceFromSchool || 0) : 
            Math.abs((student.distanceFromSchool || 0) - (sortedStudents[index - 1].distanceFromSchool || 0));

        timeline += `
            <div class="timeline-item">
                <div class="timeline-time">${arrivalTime.toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})} - ${departTime.toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}</div>
                <div class="timeline-content">
                    <strong>üè† ${student['‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']}</strong> <span style="color: #1a73e8;">(‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ó‡∏µ‡πà ${index + 1})</span><br>
                    ‡∏´‡πâ‡∏≠‡∏á ${student['‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô']} ‚Ä¢ ‡∏´‡πà‡∏≤‡∏á‡∏à‡∏≤‡∏Å‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${student.distanceFromSchool ? student.distanceFromSchool.toFixed(1) + ' ‡∏Å‡∏°.' : '‡πÑ‡∏°‡πà‡∏ó‡∏£‡∏≤‡∏ö'}<br>
                    <small style="color: #666;">
                        üöó ‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á: ${travelTime} ‡∏ô‡∏≤‡∏ó‡∏µ ‚Ä¢ üè† ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°: ${visitTime} ‡∏ô‡∏≤‡∏ó‡∏µ
                        ${index > 0 ? ` ‚Ä¢ üìè ‡∏à‡∏≤‡∏Å‡∏ö‡πâ‡∏≤‡∏ô‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤: ${distanceFromPrevious.toFixed(1)} ‡∏Å‡∏°.` : ''}
                    </small><br>
                    ${this.getStudentPriorityInfo(student)}
                </div>
            </div>
        `;
    });

    // ‡πÄ‡∏ß‡∏•‡∏≤‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
    const lastStudent = sortedStudents[sortedStudents.length - 1];
    const returnTravelTime = Math.round((lastStudent.distanceFromSchool || 0) * 2);
    cumulativeTime += returnTravelTime;

    const returnTime = new Date(startTime);
    returnTime.setMinutes(startTime.getMinutes() + cumulativeTime);

    timeline += `
        <div class="timeline-item">
            <div class="timeline-time">${returnTime.toLocaleTimeString('th-TH', {hour: '2-digit', minute: '2-digit'})}</div>
            <div class="timeline-content">
                <strong>üè´ ‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</strong><br>
                ‡∏™‡∏£‡∏∏‡∏õ‡∏ú‡∏•‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡∏∞‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•<br>
                <small style="color: #34a853;">
                    üéØ ‡πÉ‡∏ä‡πâ‡πÄ‡∏ß‡∏•‡∏≤‡∏£‡∏ß‡∏°: ${Math.floor(cumulativeTime / 60)} ‡∏ä‡∏±‡πà‡∏ß‡πÇ‡∏°‡∏á ${cumulativeTime % 60} ‡∏ô‡∏≤‡∏ó‡∏µ
                </small>
            </div>
        </div>
    `;

    return timeline;
},

// ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
getStudentPriorityInfo(student) {
    const priorityScore = this.calculatePriorityScore(student);
    const isVisited = student['‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°'] === '‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß';
    const income = student['‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ'] ? parseFloat(student['‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ'].toString().replace(/[‡∏ø,]/g, '')) : 0;
    
    let info = '<small style="color: #1a73e8;">';
    
    if (!isVisited) {
        info += 'üî¥ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏° ‚Ä¢ ';
    } else {
        info += '‚úÖ ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß ‚Ä¢ ';
    }
    
    if (priorityScore >= 6) {
        info += '‚ö†Ô∏è ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç‡∏™‡∏π‡∏á ‚Ä¢ ';
    }
    
    if (income > 0 && income < 5000) {
        info += 'üí∞ ‡∏£‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏ï‡πà‡∏≥ ‚Ä¢ ';
    }
    
    if (student['‡πÑ‡∏î‡πâ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£‡πÅ‡∏´‡πà‡∏á‡∏£‡∏±‡∏ê'] === 'TRUE') {
        info += 'üè• ‡πÑ‡∏î‡πâ‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏¥‡∏Å‡∏≤‡∏£ ‚Ä¢ ';
    }
    
    // ‡∏•‡∏ö " ‚Ä¢ " ‡∏ó‡πâ‡∏≤‡∏¢‡∏™‡∏∏‡∏î
    info = info.replace(/ ‚Ä¢ $/, '');
    info += '</small>';
    
    return info;
},



// JavaScript ‡πÅ‡∏ö‡∏ö‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏á‡πà‡∏≤‡∏¢
getCleanPreviewScript() {
    return `
        // Simple functionality  
        function toggleCheck(element) {
            if (element.classList.contains('checked')) {
                element.classList.remove('checked');
                element.innerHTML = '';
                element.style.background = '';
                element.style.border = '2px solid #1a73e8';
            } else {
                element.classList.add('checked');
                element.innerHTML = '<i class="fas fa-check" style="color: white; font-size: 12px;"></i>';
                element.style.background = '#1a73e8';
                element.style.border = '2px solid #1a73e8';
            }
            autoSave(); // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏ó‡∏±‡∏ô‡∏ó‡∏µ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÅ‡∏õ‡∏•‡∏á
        }

        // Auto-save functionality
        function autoSave() {
            const checkboxes = document.querySelectorAll('.checklist-checkbox.checked');
            const checkedTableItems = document.querySelectorAll('td:contains("‚òë")');
            
            const data = {
                checkedItems: Array.from(checkboxes).map(cb => cb.parentElement.textContent.trim()),
                visitedStudents: Array.from(checkedTableItems).map(item => item.parentElement.children[1].textContent),
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('homeVisitProgress', JSON.stringify(data));
        }

        // Load saved data
        function loadSavedData() {
            const saved = localStorage.getItem('homeVisitProgress');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    console.log('Loaded saved progress:', data);
                } catch (e) {
                    console.log('No valid saved data found');
                }
            }
        }

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üìã Clean preview initialized');
            
            // Load any saved progress
            loadSavedData();
            
            // Auto-save every 30 seconds
            setInterval(autoSave, 30000);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', function(e) {
                if (e.ctrlKey && e.key === 'p') {
                    e.preventDefault();
                    window.print();
                }
                if (e.key === 'Escape') {
                    window.close();
                }
                if (e.ctrlKey && e.key === 's') {
                    e.preventDefault();
                    autoSave();
                    showNotification('‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡πâ‡∏ß');
                }
            });

            // Show notification function
            function showNotification(message) {
                const notification = document.createElement('div');
                notification.style.cssText = \`
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background: #1a73e8;
                    color: white;
                    padding: 12px 20px;
                    border-radius: 6px;
                    z-index: 9999;
                    font-size: 14px;
                    animation: slideIn 0.3s ease-out;
                \`;
                notification.innerHTML = \`<i class="fas fa-check"></i> \${message}\`;
                document.body.appendChild(notification);
                
                setTimeout(() => notification.remove(), 3000);
            }
            
            // Add slide-in animation
            const style = document.createElement('style');
            style.textContent = \`
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
            \`;
            document.head.appendChild(style);
            
            console.log('‚úÖ Clean preview fully loaded');
        });

        // Before unload - save progress
        window.addEventListener('beforeunload', function() {
            autoSave();
        });

        // Add click handlers to table checkboxes
        document.addEventListener('click', function(e) {
            if (e.target.textContent === '‚ñ° ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß') {
                e.target.textContent = e.target.textContent === '‚ñ° ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß' ? '‚òë ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß' : '‚ñ° ‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡πÅ‡∏•‡πâ‡∏ß';
                e.target.style.color = e.target.textContent.includes('‚òë') ? '#155724' : '#333';
                autoSave();
            }
        });
    `;
},

// ‡∏ü‡∏≠‡∏£‡πå‡πÅ‡∏°‡∏ï‡πÄ‡∏á‡∏¥‡∏ô (‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°)
formatCurrency(amount) {
    if (!amount) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    const numAmount = parseFloat(amount.toString().replace(/[‡∏ø,]/g, ''));
    if (isNaN(numAmount)) return '‡πÑ‡∏°‡πà‡∏£‡∏∞‡∏ö‡∏∏';
    
    if (numAmount < 5000) return `${numAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó (‡∏ï‡πà‡∏≥)`;
    if (numAmount < 15000) return `${numAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó (‡∏õ‡∏≤‡∏ô‡∏Å‡∏•‡∏≤‡∏á)`;
    return `${numAmount.toLocaleString()} ‡∏ö‡∏≤‡∏ó`;
},
  
  
  ///////////////////////////////////////
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á Google Maps
    generateGoogleRoute() {
        const selectedStudents = this.getSelectedStudents();
        const maxVisits = parseInt(document.getElementById('googleMaxVisits').value);
        
        if (selectedStudents.length === 0) {
            this.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏Å‡πà‡∏≠‡∏ô', 'warning');
            return;
        }
        
        if (selectedStudents.length > maxVisits) {
            this.showToast(`‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î ${maxVisits} ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ß‡πâ ${selectedStudents.length} ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô)`, 'error');
            return;
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡πÅ‡∏•‡∏∞‡πÄ‡∏õ‡∏¥‡∏î Google Maps
        const googleMapsUrl = this.generateGoogleMapsUrl(selectedStudents);
        
        // ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô
        this.optimizedRoute = selectedStudents;
        
        // ‡πÄ‡∏õ‡∏¥‡∏î Google Maps
        window.open(googleMapsUrl, '_blank');
        
        // ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à
        this.showToast(`‡πÄ‡∏õ‡∏¥‡∏î Google Maps ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö ${selectedStudents.length} ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß`, 'success');
        
        // ‡∏õ‡∏¥‡∏î modal
        const modal = bootstrap.Modal.getInstance(document.getElementById('routePlanningGoogleModal'));
        if (modal) modal.hide();
        
        console.log('üó∫Ô∏è Google Maps route generated for', selectedStudents.length, 'students');
    },
    
    // ‡∏î‡∏∂‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    getSelectedStudents() {
        const selectedStudents = [];
        // ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏â‡∏û‡∏≤‡∏∞ checkbox ‡∏ó‡∏µ‡πà checked ‡πÅ‡∏•‡∏∞ parent element ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏¢‡∏π‡πà
        document.querySelectorAll('.google-student-checkbox:checked').forEach(checkbox => {
            const parentItem = checkbox.closest('.google-student-item');
            // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤ item ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•‡∏≠‡∏¢‡∏π‡πà‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà (‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ã‡πà‡∏≠‡∏ô‡∏à‡∏≤‡∏Å‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤)
            if (parentItem && parentItem.style.display !== 'none') {
                const studentIndex = parseInt(checkbox.value);
                const student = homeVisitData[studentIndex];
                if (student && student['LatLongHome']) {
                    selectedStudents.push({
                        ...student,
                        originalIndex: studentIndex
                    });
                }
            }
        });
        
        // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ï‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤
        return this.sortSelectedStudents(selectedStudents);
    },
    
    // ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å
    sortSelectedStudents(students) {
        const sortBy = document.getElementById('googleSortBy').value;
        
        return students.sort((a, b) => {
            switch (sortBy) {
                case 'distance':
                    return (a.distanceFromSchool || 999) - (b.distanceFromSchool || 999);
                case 'priority':
                    return this.calculatePriorityScore(b) - this.calculatePriorityScore(a);
                case 'class':
                    return (a['‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] || '').localeCompare(b['‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô'] || '');
                case 'name':
                    return (a['‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '').localeCompare(b['‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•'] || '');
                default:
                    return 0;
            }
        });
    },
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Google Maps
    generateGoogleMapsUrl(students, preview = false) {
        // ‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô)
        const schoolCoords = '14.222052,99.472970';
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏∏‡∏î‡∏´‡∏¢‡∏∏‡∏î
        const waypoints = students.map(student => {
            const coords = student['LatLongHome'].replace(/\s+/g, '');
            return coords;
        }).join('|');
        
        // ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
        const travelMode = document.getElementById('googleTravelMode').value;
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á URL
        let url = 'https://www.google.com/maps/dir/';
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
        url += `${schoolCoords}/`;
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏´‡∏¢‡∏∏‡∏î
        students.forEach(student => {
            const coords = student['LatLongHome'].replace(/\s+/g, '');
            url += `${coords}/`;
        });
        
        // ‡∏Å‡∏•‡∏±‡∏ö‡πÇ‡∏£‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
        url += `${schoolCoords}/`;
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå
        url += `?hl=th&dirflg=${this.getTravelModeCode(travelMode)}`;
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°
        if (!preview) {
            url += '&travelmode=' + travelMode;
            url += '&units=metric';
        }
        
        return url;
    },
    
    // ‡πÅ‡∏õ‡∏•‡∏á‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
    getTravelModeCode(mode) {
        const modes = {
            'driving': 'd',
            'walking': 'w',
            'bicycling': 'b',
            'transit': 'r'
        };
        return modes[mode] || 'd';
    },
    
    // ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡πÄ‡∏î‡∏¥‡∏ô‡∏ó‡∏≤‡∏á
    getTravelModeText() {
        const mode = document.getElementById('googleTravelMode').value;
        const modes = {
            'driving': 'üöó ‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ',
            'walking': 'üö∂ ‡πÄ‡∏î‡∏¥‡∏ô‡πÄ‡∏ó‡πâ‡∏≤',
            'bicycling': 'üö¥ ‡∏à‡∏±‡∏Å‡∏£‡∏¢‡∏≤‡∏ô',
            'transit': 'üöå ‡∏Ç‡∏ô‡∏™‡πà‡∏á‡∏™‡∏≤‡∏ò‡∏≤‡∏£‡∏ì‡∏∞'
        };
        return modes[mode] || '‡∏Ç‡∏±‡∏ö‡∏£‡∏ñ';
    },
    
    // ‡πÑ‡∏î‡πâ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏•‡∏≥‡∏î‡∏±‡∏ö
    getSortByText() {
        const sortBy = document.getElementById('googleSortBy').value;
        const sorts = {
            'distance': '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î',
            'priority': '‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç',
            'class': '‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô',
            'name': '‡∏ä‡∏∑‡πà‡∏≠ A-Z'
        };
        return sorts[sortBy] || '‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á‡πÉ‡∏Å‡∏•‡πâ‡∏™‡∏∏‡∏î';
    },
    
    // ‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á
    shareRoute() {
        const selectedStudents = this.getSelectedStudents();
        if (selectedStudents.length === 0) {
            this.showToast('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏Å‡πà‡∏≠‡∏ô', 'warning');
            return;
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏£‡πå
        const routeText = this.generateShareText(selectedStudents);
        
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ LINE LIFF ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
        if (typeof liff !== 'undefined' && liff.isLoggedIn()) {
            // ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô LINE
            this.shareViaLine(routeText, selectedStudents);
        } else {
            // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
            this.copyToClipboard(routeText);
        }
    },
    
    // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏ä‡∏£‡πå
    generateShareText(students) {
        const totalDistance = students.reduce((sum, student) => {
            return sum + (student.distanceFromSchool || 0);
        }, 0);
        
        const estimatedTime = students.length * 30 + totalDistance * 3;
        
        let text = `üìç ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô\n\n`;
        text += `üïê ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà: ${new Date().toLocaleDateString('th-TH')}\n`;
        text += `üë• ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${students.length} ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô\n`;
        text += `üöó ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó: ${this.getTravelModeText()}\n`;
        text += `üìè ‡∏£‡∏∞‡∏¢‡∏∞‡∏ó‡∏≤‡∏á: ${totalDistance.toFixed(1)} ‡∏Å‡∏°. (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)\n`;
        text += `‚è±Ô∏è ‡πÄ‡∏ß‡∏•‡∏≤: ${Math.round(estimatedTime)} ‡∏ô‡∏≤‡∏ó‡∏µ (‡∏õ‡∏£‡∏∞‡∏°‡∏≤‡∏ì)\n\n`;
        
        text += `üìã ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°:\n`;
        students.forEach((student, index) => {
            text += `${index + 1}. ${student['‡∏ä‡∏∑‡πà‡∏≠‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•']} (${student['‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô']})\n`;
        });
        
        text += `\nüó∫Ô∏è Google Maps: ${this.generateGoogleMapsUrl(students)}`;
        
        return text;
    },
    
    // ‡πÅ‡∏ä‡∏£‡πå‡∏ú‡πà‡∏≤‡∏ô LINE
    shareViaLine(text, students) {
        if (typeof liff === 'undefined') {
            this.copyToClipboard(text);
            return;
        }
        
        // ‡∏™‡∏£‡πâ‡∏≤‡∏á Flex Message
        const flexMessage = {
            type: "flex",
            altText: "‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
            contents: {
                type: "bubble",
                size: "giga",
                header: {
                    type: "box",
                    layout: "vertical",
                    contents: [
                        {
                            type: "text",
                            text: "üìç ‡πÅ‡∏ú‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏¢‡∏µ‡πà‡∏¢‡∏°‡∏ö‡πâ‡∏≤‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô",
                            weight: "bold",
                            size: "lg",
                            color: "#ffffff"
                        },
                        {
                            type: "text",
                            text: new Date().toLocaleDateString('th-TH'),
                            size: "sm",
                            color: "#ffffff",
                            margin: "sm"
                        }
                    ],
                    backgroundColor: "#28a745",
                    paddingAll: "20px"
                },
                body: {
                    type: "box",
                    layout: "vertical",
                    contents: [
                        {
                            type: "box",
                            layout: "baseline",
                            contents: [
                                { type: "text", text: "‡∏à‡∏≥‡∏ô‡∏ß‡∏ô:", flex: 2, size: "sm", color: "#aaaaaa" },
                                { type: "text", text: `${students.length} ‡∏Ñ‡∏£‡∏±‡∏ß‡πÄ‡∏£‡∏∑‡∏≠‡∏ô`, flex: 3, size: "sm", weight: "bold" }
                            ]
                        },
                        {
                            type: "box",
                            layout: "baseline",
                            contents: [
                                { type: "text", text: "‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó:", flex: 2, size: "sm", color: "#aaaaaa" },
                                { type: "text", text: this.getTravelModeText(), flex: 3, size: "sm" }
                            ],
                            margin: "sm"
                        }
                    ]
                },
                footer: {
                    type: "box",
                    layout: "vertical",
                    contents: [
                        {
                            type: "button",
                            style: "primary",
                            height: "sm",
                            action: {
                                type: "uri",
                                label: "üó∫Ô∏è ‡πÄ‡∏õ‡∏¥‡∏î Google Maps",
                                uri: this.generateGoogleMapsUrl(students)
                            },
                            color: "#4285f4"
                        }
                    ]
                }
            }
        };
        
        liff.shareTargetPicker([flexMessage])
            .then(() => {
                this.showToast('‡πÅ‡∏ä‡∏£‡πå‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
            })
            .catch(error => {
                console.error('Error sharing:', error);
                this.copyToClipboard(text);
            });
    },
    
    // ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°
    copyToClipboard(text) {
        if (navigator.clipboard) {
            navigator.clipboard.writeText(text).then(() => {
                this.showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'success');
            }).catch(() => {
                this.fallbackCopyTextToClipboard(text);
            });
        } else {
            this.fallbackCopyTextToClipboard(text);
        }
    },
    
    // ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏™‡∏≥‡∏£‡∏≠‡∏á
    fallbackCopyTextToClipboard(text) {
        const textArea = document.createElement("textarea");
        textArea.value = text;
        textArea.style.top = "0";
        textArea.style.left = "0";
        textArea.style.position = "fixed";
        
        document.body.appendChild(textArea);
        textArea.focus();
        textArea.select();
        
        try {
            document.execCommand('copy');
            this.showToast('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏™‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡πâ‡∏ß', 'success');
        } catch (err) {
            this.showToast('‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÑ‡∏î‡πâ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏î‡πâ‡∏ß‡∏¢‡∏ï‡∏ô‡πÄ‡∏≠‡∏á', 'error');
        }
        
        document.body.removeChild(textArea);
    },
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏Å‡∏≤‡∏£‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Toast
    showToast(message, type = 'info') {
        const toastId = 'googleRouteToast_' + Date.now();
        const bgClass = {
            'success': 'bg-success',
            'error': 'bg-danger',
            'warning': 'bg-warning',
            'info': 'bg-info'
        }[type] || 'bg-info';
        
        const icon = {
            'success': 'fas fa-check-circle',
            'error': 'fas fa-exclamation-circle',
            'warning': 'fas fa-exclamation-triangle',
            'info': 'fas fa-info-circle'
        }[type] || 'fas fa-info-circle';
        
        const toastHTML = `
            <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 9999;">
                <div id="${toastId}" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="toast-header ${bgClass} text-white">
                        <i class="${icon} me-2"></i>
                        <strong class="me-auto">Google Maps Route</strong>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                    <div class="toast-body">
                        ${message}
                    </div>
                </div>
            </div>
        `;
        
        // ‡πÄ‡∏û‡∏¥‡πà‡∏° toast
        document.body.insertAdjacentHTML('beforeend', toastHTML);
        
        // ‡πÅ‡∏™‡∏î‡∏á toast
        const toast = new bootstrap.Toast(document.getElementById(toastId), {
            autohide: true,
            delay: type === 'error' ? 5000 : 3000
        });
        toast.show();
        
        // ‡∏•‡∏ö toast ‡∏´‡∏•‡∏±‡∏á‡∏à‡∏≤‡∏Å‡∏õ‡∏¥‡∏î
        document.getElementById(toastId).addEventListener('hidden.bs.toast', function() {
            this.parentNode.remove();
        });
    }
};

// ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡πÄ‡∏°‡∏∑‡πà‡∏≠ DOM ‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
document.addEventListener('DOMContentLoaded', function() {
    // ‡∏£‡∏≠‡πÉ‡∏´‡πâ‡∏£‡∏∞‡∏ö‡∏ö‡∏´‡∏•‡∏±‡∏Å‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à‡∏Å‡πà‡∏≠‡∏ô
    setTimeout(() => {
        RoutePlanningGoogle.init();
    }, 1500);
});

// ‡∏ü‡∏±‡∏á‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
document.addEventListener('dataLoaded', function() {
    if (RoutePlanningGoogle.isInitialized) {
        console.log('üîÑ Google route planning data updated');
    }
});